<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Dynamic</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Sarabun', sans-serif;
            color: #343a40;
        }
        .upload-container {
            max-width: 700px; margin: 5rem auto; padding: 2.5rem;
            background-color: #ffffff; border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0,0,0,.07);
            text-align: center; border: 1px solid #dee2e6;
        }
        .card {
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,.05);
            border-radius: 1rem; height: 100%;
        }
        .card-header {
            background: linear-gradient(to right, #007bff, #0056b3);
            color: white; font-weight: bold; border-top-left-radius: 1rem;
            border-top-right-radius: 1rem; border-bottom: none; padding: 1rem 1.5rem;
        }
        .kpi-card .card-body { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover .card-body { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,.1); }
        .chart-container { position: relative; width: 100%; }
        .form-select:focus, .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #e9ecef; }
        .sort-asc::after { content: ' ▲'; font-size: 0.8em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.8em; }
        .filter-row {
            background-color: #f1f3f5;
            border-radius: 0.5rem;
        }
        .header-select-list, #sheet-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .border-dashed {
            border: 2px dashed #dee2e6 !important;
        }
        .template-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,.1);
            border-color: #007bff !important;
        }
        .chart-preview-container {
            height: 150px;
            position: relative;
        }
    </style>
</head>
<body>

    <div class="container-fluid p-4">
        
        <!-- Upload View -->
        <div id="upload-view">
            <div class="upload-container">
                <h1 class="mb-3">Dashboard Dynamic</h1>
                <p class="text-muted">โปรดอัปโหลดไฟล์ Excel (.xlsx, .xls) เพื่อเริ่มต้นการวิเคราะห์</p>
                <hr class="my-4">
                <input type="file" id="excel-input" class="form-control form-control-lg" accept=".xlsx, .xls">
                <div id="loading-spinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    <p class="mt-2" id="loading-status">กำลังประมวลผลไฟล์...</p>
                </div>
                <div id="upload-error" class="text-danger mt-3"></div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="d-none">
            <div id="pdf-export-area">
                <header class="mb-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <h1 class="mb-0">ผลการวิเคราะห์</h1>
                        <!-- Sheet switcher will be placed here -->
                        <div id="sheet-switcher-container" class="mt-2"></div>
                        <p id="file-info" class="text-muted small mt-1">ภาพรวมข้อมูลจากไฟล์ของคุณ</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap justify-content-end" id="dashboard-actions">
                        <button id="create-kpi-btn" class="btn btn-info text-white"><i class="bi bi-calculator-fill me-2"></i>สร้าง KPI</button>
                        <button id="create-chart-btn" class="btn btn-primary"><i class="bi bi-plus-circle-dotted me-2"></i>สร้างกราฟ</button>
                        
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="settingsMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear-fill me-1"></i> ตั้งค่า
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="settingsMenuButton">
                                <li><a class="dropdown-item" href="#" id="save-config-btn"><i class="bi bi-download me-2"></i>บันทึกการตั้งค่า (ไฟล์)</a></li>
                                <li><a class="dropdown-item" href="#" id="load-config-btn"><i class="bi bi-upload me-2"></i>นำเข้าการตั้งค่า (ไฟล์)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="export-csv-btn"><i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>ส่งออกเป็น CSV</a></li>
                                <li><a class="dropdown-item" href="#" id="export-pdf-btn"><i class="bi bi-file-earmark-pdf-fill me-2"></i>ส่งออกเป็น PDF</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" id="clear-storage-btn"><i class="bi bi-trash3-fill me-2"></i>ล้างค่าที่บันทึกไว้ (ในเครื่อง)</a></li>
                            </ul>
                        </div>
                        <input type="file" id="load-config-input" class="d-none" accept=".json">

                        <button id="upload-new-button" class="btn btn-outline-secondary"><i class="bi bi-arrow-clockwise me-2"></i>อัปโหลดไฟล์ใหม่</button>
                    </div>
                </header>

                <!-- KPIs Section -->
                <div id="kpis-container" class="row mb-4">
                     <div id="no-kpis-placeholder" class="col-12 text-center text-muted py-4">
                        <div class="card p-4 bg-light border-dashed">
                            <i class="bi bi-calculator fs-1"></i>
                            <h5 class="mt-3">ยังไม่มี KPI</h5>
                            <p class="mb-0">คลิกที่ปุ่ม "สร้าง KPI" เพื่อเพิ่มการ์ดชี้วัด</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div id="charts-container" class="row mb-4">
                     <div id="no-charts-placeholder" class="col-12 text-center text-muted py-4">
                        <div class="card p-4 bg-light border-dashed">
                            <i class="bi bi-bar-chart-line fs-1"></i>
                            <h5 class="mt-3">ยังไม่มีกราฟ</h5>
                            <p class="mb-0">คลิกที่ปุ่ม "สร้างกราฟ" เพื่อเริ่มสร้างการแสดงผลข้อมูลของคุณ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter & Data Table Section -->
            <div class="card">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">ตัวกรองข้อมูล (Filters)</h5>
                    <div id="filter-builder-container" class="mb-4">
                        <!-- Dynamic filters will be added here -->
                    </div>
                    <button id="add-filter-btn" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-lg me-1"></i> เพิ่มฟิลเตอร์</button>
                    <hr>
                    <h5 class="card-title mb-3">ตารางข้อมูล</h5>
                    
                    <!-- Table Controls -->
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-3">
                        <div class="d-flex align-items-center gap-2">
                            <label for="rows-per-page-select" class="col-form-label col-form-label-sm">แสดง</label>
                            <select id="rows-per-page-select" class="form-select form-select-sm" style="width: 75px;">
                                <option value="15" selected>15</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="col-form-label col-form-label-sm">รายการ</span>
                        </div>
                        <div id="pagination-controls"></div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead id="data-table-header"></thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                        <div id="no-results" class="text-center py-5 text-muted d-none"><p>ไม่พบข้อมูลที่ตรงกับเงื่อนไข</p></div>
                    </div>
                </div>
            </div>
            
            <footer class="text-center text-sm text-muted mt-5"><p id="footer-text">Chatrium© 2024</p></footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="sheet-select-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">เลือกชีตที่จะนำมาวิเคราะห์</h5></div>
          <div class="modal-body">
            <p class="text-muted">ไฟล์ Excel ของคุณมีหลายชีต กรุณาเลือกชีตที่ต้องการ (สามารถเลือกได้หลายชีต)</p>
            <div id="sheet-list" class="list-group">
                <!-- Checkboxes will be injected here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="process-selected-sheets-btn">ดำเนินการต่อ</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="template-select-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">เลือกรูปแบบการวิเคราะห์ (Template)</h5>
          </div>
          <div class="modal-body">
            <p class="text-muted">เราได้วิเคราะห์ข้อมูลของคุณและสร้างเทมเพลตเริ่มต้นให้เลือก หรือคุณสามารถเลือก "เริ่มต้นจากศูนย์" เพื่อตั้งค่าเองทั้งหมด</p>
            <div id="template-card-container" class="row g-3 mt-2">
                <!-- Template cards will be injected here by JavaScript -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" id="start-from-scratch-button">
                <i class="bi bi-tools me-2"></i>เริ่มต้นจากศูนย์ (ตั้งค่าเอง)
            </button>
          </div>
        </div>
      </div>
    </div>


    <div class="modal fade" id="header-select-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">เลือกคอลัมน์ (Headers) ที่จะใช้</h5></div>
          <div class="modal-body">
            <p class="text-muted">เลือกคอลัมน์ที่คุณต้องการนำมาวิเคราะห์ในแดชบอร์ด</p>
            <div id="header-select-list" class="list-group header-select-list"></div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-primary" id="apply-header-select-button">ดำเนินการต่อ</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="kpi-modal" tabindex="-1" aria-labelledby="kpiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="kpiModalLabel">สร้าง KPI ใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="create-kpi-form">
                        <div class="mb-3"><label for="kpi-title" class="form-label">ชื่อ KPI</label><input type="text" class="form-control" id="kpi-title" required></div>
                        <div class="mb-3"><label for="kpi-calculation" class="form-label">วิธีการคำนวณ</label><select class="form-select" id="kpi-calculation" required></select></div>
                        <div class="mb-3" id="kpi-column-container"><label for="kpi-column" class="form-label">เลือกคอลัมน์</label><select class="form-select" id="kpi-column" required></select></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" id="save-kpi-button">บันทึก KPI</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="create-chart-modal" tabindex="-1" aria-labelledby="createChartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="createChartModalLabel">สร้างกราฟใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="create-chart-form">
              <div class="mb-3"><label for="chart-title" class="form-label">ชื่อกราฟ</label><input type="text" class="form-control" id="chart-title" required></div>
              <div class="mb-3"><label for="chart-type" class="form-label">ประเภทกราฟ</label><select class="form-select" id="chart-type"><option value="bar">กราฟแท่ง (Bar)</option><option value="pie">กราฟวงกลม (Pie)</option><option value="doughnut">กราฟโดนัท (Doughnut)</option><option value="line">กราฟเส้น (Line)</option></select></div>
              <div class="mb-3"><label for="chart-group-by" class="form-label">จัดกลุ่มข้อมูลด้วย (Group By)</label><select class="form-select" id="chart-group-by" required></select></div>
              <div class="mb-3"><label for="chart-metric" class="form-label">ค่าที่ต้องการวัด (Measure)</label><select class="form-select" id="chart-metric" required></select></div>
              <div class="mb-3" id="metric-aggregation-container"><label for="chart-metric-aggregation" class="form-label">วิธีการคำนวณ</label><select class="form-select" id="chart-metric-aggregation"><option value="sum">ผลรวม (Sum)</option><option value="average">ค่าเฉลี่ย (Average)</option></select></div>
            </form>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" id="save-chart-button">บันทึกกราฟ</button></div>
        </div>
      </div>
    </div>


    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/parn-pon/thaifont-jspdf/Sarabun-Regular-normal.js"></script>


    <!-- Main Application Script -->
    <script>
        // --- GLOBAL STATE ---
        let fullOriginalData = [];
        let originalData = [];
        let filteredData = [];
        let allHeaders = [];
        let headers = [];
        let numericHeaders = [];
        let activeFilters = [];
        let userKPIs = [];
        let userCharts = [];
        let chartInstances = {};
        let workbook;
        let workbookDataStore = {};
        let currentFileName = '';
        let currentSheetName = '';
        let currentPage = 1;
        let rowsPerPage = 15;
        let sortKey = '';
        let sortDir = 'asc';
        
        let sheetSelectModal, headerSelectModal, kpiModal, createChartModal, templateSelectModal;

        // --- DOM ELEMENTS ---
        const getEl = (id) => document.getElementById(id);
        const uploadView = getEl('upload-view');
        const dashboardView = getEl('dashboard-view');
        const excelInput = getEl('excel-input');
        const loadingSpinner = getEl('loading-spinner');
        const loadingStatusEl = getEl('loading-status');
        const uploadErrorEl = getEl('upload-error');
        const fileInfoEl = getEl('file-info');
        const sheetList = getEl('sheet-list');
        const tableHeaderEl = getEl('data-table-header');
        const tableBodyEl = getEl('data-table-body');
        const noResultsEl = getEl('no-results');
        const paginationControls = getEl('pagination-controls');
        const filterBuilderContainer = getEl('filter-builder-container');
        const kpisContainer = getEl('kpis-container');
        const noKpisPlaceholder = getEl('no-kpis-placeholder');
        const chartsContainer = getEl('charts-container');
        const noChartsPlaceholder = getEl('no-charts-placeholder');

        // --- FILE & DATA LOADING ---

        function processInChunks(array, processItem, onComplete, chunkSize = 2000) {
            let index = 0;
            const total = array.length;
            
            function chunk() {
                const end = Math.min(index + chunkSize, total);
                for (; index < end; index++) {
                    processItem(array[index]);
                }
                loadingStatusEl.textContent = `กำลังประมวลผลข้อมูล... แถวที่ ${index.toLocaleString()} จาก ${total.toLocaleString()}`;
                if (index < total) {
                    requestAnimationFrame(chunk);
                } else {
                    onComplete();
                }
            }
            chunk();
        }

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            currentFileName = file.name;
            loadingSpinner.style.display = 'block';
            uploadErrorEl.textContent = '';
            loadingStatusEl.textContent = 'กำลังอ่านไฟล์...';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                     setTimeout(() => {
                        workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        if (workbook.SheetNames.length === 1) {
                            processAndStoreSheets([workbook.SheetNames[0]]);
                        } else {
                            const sheetListContainer = getEl('sheet-list');
                            sheetListContainer.innerHTML = '';
                            workbook.SheetNames.forEach(name => {
                                const item = document.createElement('label');
                                item.className = 'list-group-item';
                                item.innerHTML = `<input class="form-check-input me-2" type="checkbox" value="${name}" checked> ${name}`;
                                sheetListContainer.appendChild(item);
                            });
                            loadingSpinner.style.display = 'none';
                            sheetSelectModal.show();
                        }
                    }, 10);
                } catch (error) {
                    uploadErrorEl.textContent = "เกิดข้อผิดพลาดในการอ่านไฟล์: " + error.message;
                    loadingSpinner.style.display = 'none';
                }
            };
            reader.onerror = () => { uploadErrorEl.textContent = "ไม่สามารถอ่านไฟล์ได้"; loadingSpinner.style.display = 'none';};
            reader.readAsArrayBuffer(file);
            excelInput.value = '';
        }
        
        /**
         * Analyzes the first few rows of a sheet to find the most likely header row using a scoring system.
         * @param {Array<Array<string>>} dataAsArray - The sheet data as an array of arrays.
         * @returns {number} The index of the detected header row, or -1 if not found.
         */
        function findHeaderRow(dataAsArray) {
            let bestGuess = { index: -1, score: -Infinity };
            const searchLimit = Math.min(dataAsArray.length, 20);

            for (let i = 0; i < searchLimit; i++) {
                const row = dataAsArray[i];
                let score = 0;
                const nonEmptyCells = row.filter(cell => cell !== null && cell !== undefined && String(cell).trim() !== '');

                if (nonEmptyCells.length < 2) {
                    continue; // Skip rows that are too sparse
                }

                nonEmptyCells.forEach(cell => {
                    const value = String(cell);
                    // Penalize numbers
                    if (!isNaN(parseFloat(value)) && isFinite(value)) {
                        score -= 1;
                    }
                    // Reward strings
                    else if (typeof value === 'string') {
                        score += 1;
                    }
                    // Penalize long strings (likely data)
                    if (value.length > 50) {
                        score -= 2;
                    }
                    // Penalize data-like formats
                    if (value.includes('@') || value.includes('http')) {
                        score -= 2;
                    }
                });

                // Give a bonus for having more columns than the previous best guess
                score += nonEmptyCells.length * 0.5;

                if (score > bestGuess.score) {
                    bestGuess.score = score;
                    bestGuess.index = i;
                }
            }
            return bestGuess.index;
        }

        function processAndStoreSheets(sheetNames) {
            try {
                if (sheetSelectModal) sheetSelectModal.hide();
                loadingSpinner.style.display = 'block';
                uploadErrorEl.textContent = '';
                
                workbookDataStore = {};

                sheetNames.forEach(sheetName => {
                    loadingStatusEl.textContent = `กำลังอ่านชีต: ${sheetName}...`;
                    const ws = workbook.Sheets[sheetName];
                    if (!ws) return;

                    const dataAsArray = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                    if (dataAsArray.length === 0) return;

                    const headerRowIndex = findHeaderRow(dataAsArray);
                    if (headerRowIndex === -1) return;

                    const rawHeaders = dataAsArray[headerRowIndex].filter(h => h && String(h).trim());
                    const dataRows = dataAsArray.slice(headerRowIndex + 1);

                    const jsonData = dataRows.map(row => {
                        const obj = {};
                        rawHeaders.forEach(header => {
                            const originalIndex = dataAsArray[headerRowIndex].indexOf(header);
                            obj[header] = row[originalIndex];
                        });
                        return obj;
                    });
                    
                    const sanitizedHeaders = rawHeaders.map(h => String(h).trim().replace(/[.\s]/g, '_'));
                    const sheetData = [];
                    jsonData.forEach(row => {
                        const newRow = {};
                        rawHeaders.forEach((originalHeader, i) => {
                            const sanitizedHeader = sanitizedHeaders[i];
                            newRow[sanitizedHeader] = row[originalHeader];
                        });
                        sheetData.push(newRow);
                    });

                    workbookDataStore[sheetName] = {
                        data: sheetData,
                        headers: sanitizedHeaders
                    };
                });

                if (Object.keys(workbookDataStore).length === 0) {
                    throw new Error("ไม่สามารถประมวลผลชีตที่เลือกได้ หรือชีตไม่มีข้อมูล");
                }

                setActiveSheet(sheetNames[0]);

            } catch (error) {
                uploadErrorEl.textContent = "เกิดข้อผิดพลาดในการประมวลผล: " + error.message;
                loadingSpinner.style.display = 'none';
            }
        }

        function setActiveSheet(sheetName) {
            if (!workbookDataStore[sheetName]) return;

            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            currentSheetName = sheetName;
            const sheetInfo = workbookDataStore[sheetName];
            fullOriginalData = sheetInfo.data;
            allHeaders = sheetInfo.headers;

            prepareDataAndShowTemplates();
        }
        
        function prepareDataAndShowTemplates() {
            loadingStatusEl.textContent = `กำลังวิเคราะห์ชีต: ${currentSheetName}...`;
            setTimeout(() => {
                detectNumericHeaders();
                convertNumericColumns();
                if (dashboardView.classList.contains('d-none')) {
                    generateAndShowTemplates();
                } else {
                    headers = [...allHeaders];
                    originalData = [...fullOriginalData];
                    initializeDashboard();
                }
            }, 10);
        }

        function detectNumericHeaders() {
            const alwaysNumericColumns = ['Ttl_ Rev_', 'Rm Rev_', 'F&B Rev_', 'Extra Rev_', 'Non Rev_'];
            numericHeaders = allHeaders.filter(h => {
                const isForceNumeric = alwaysNumericColumns.some(pattern => 
                    h.toLowerCase().includes(pattern.toLowerCase()) || 
                    h.includes('Rev_') || h.includes('revenue') || h.includes('amount') ||
                    h.includes('price') || h.includes('cost') || h.includes('total') ||
                    h.includes('qty') || h.includes('quantity')
                );
                if (isForceNumeric) return true;
                
                const nonEmptyValues = fullOriginalData.filter(row => {
                    const val = row[h];
                    return val !== null && val !== undefined && val !== '' && String(val).trim() !== '';
                }).map(row => row[h]);
                
                if (nonEmptyValues.length < 10) return false;
                
                const numericCount = nonEmptyValues.filter(val => {
                    const strVal = String(val).trim();
                    const cleanVal = strVal.replace(/[,\s฿$€£¥]/g, '').replace(/^\((.+)\)$/, '-$1');
                    const numVal = parseFloat(cleanVal);
                    return !isNaN(numVal) && isFinite(numVal) && /\d/.test(strVal);
                }).length;
                
                return (numericCount / nonEmptyValues.length) >= 0.5;
            });
        }

        function convertNumericColumns(data = fullOriginalData, headersToConvert = numericHeaders) {
            data.forEach(row => {
                headersToConvert.forEach(h => {
                    const val = row[h];
                    if (val !== null && val !== undefined && val !== '') {
                        const strVal = String(val).trim();
                        let cleanVal = strVal.replace(/[,\s฿$€£¥"']/g, '').replace(/^\((.+)\)$/, '-$1').replace(/[^\d.-]/g, '');
                        let numVal = parseFloat(cleanVal);
                        
                        if (!isNaN(numVal) && isFinite(numVal)) {
                            row[h] = numVal;
                        } else {
                            const numberMatch = strVal.match(/[-+]?[\d,]+\.?\d*/);
                            if (numberMatch) {
                                const extractedNum = parseFloat(numberMatch[0].replace(/,/g, ''));
                                row[h] = !isNaN(extractedNum) ? extractedNum : 0;
                            } else {
                                row[h] = 0;
                            }
                        }
                    } else {
                        row[h] = 0;
                    }
                });
            });
        }


        function showHeadeerSelectionModal() {
            const listContainer = getEl('header-select-list');
            listContainer.innerHTML = '';
            const savedConfig = loadStateFromLocalStorage();
            const savedHeaders = savedConfig ? savedConfig.headers : null;

            allHeaders.forEach(header => {
                const isChecked = savedHeaders ? savedHeaders.includes(header) : true;
                const item = document.createElement('label');
                item.className = 'list-group-item';
                item.innerHTML = `<input class="form-check-input me-2" type="checkbox" value="${header}" ${isChecked ? 'checked' : ''}> ${header}`;
                listContainer.appendChild(item);
            });
            loadingSpinner.style.display = 'none';
            headerSelectModal.show();
        }

        function applyHeaderSelection() {
            const selectedCheckboxes = getEl('header-select-list').querySelectorAll('input:checked');
            let selectedHeaders = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            headers = selectedHeaders.filter(h => allHeaders.includes(h));

            if (headers.length === 0) {
                alert('กรุณาเลือกอย่างน้อย 1 คอลัมน์');
                return;
            }
            
            headerSelectModal.hide();
            loadingSpinner.style.display = 'block';
            
            originalData = fullOriginalData.map(fullRow => {
                const newRow = {};
                headers.forEach(h => { newRow[h] = fullRow[h]; });
                return newRow;
            });

            detectNumericHeaders();
            convertNumericColumns(originalData, numericHeaders);

            loadingSpinner.style.display = 'none';
            initializeDashboard();
        }
        
        // --- TEMPLATE ENGINE (UPGRADED) ---
        function generateDashboardTemplates(allHeaders, numericHeaders) {
            const templates = [];
            const lowerCaseHeaders = allHeaders.map(h => h.toLowerCase());

            const findCol = (keywords) => allHeaders.find(h => keywords.some(k => h.toLowerCase().includes(k)));
            const findCols = (keywords) => allHeaders.filter(h => keywords.some(k => h.toLowerCase().includes(k)));

            // --- Define Keywords for different domains ---
            const revenueKeywords = ['rev', 'revenue', 'income', 'sales', 'amount', 'price', 'value'];
            const costKeywords = ['cost', 'expense'];
            const dateKeywords = ['date', 'day', 'timestamp', 'period'];
            const categoryKeywords = ['category', 'type', 'market', 'segment', 'group'];
            const geoKeywords = ['country', 'city', 'province', 'region', 'area'];
            const productKeywords = ['product', 'item', 'service', 'sku'];
            const quantityKeywords = ['qty', 'quantity', 'units'];
            const customerKeywords = ['customer', 'client', 'user', 'member'];
            const employeeKeywords = ['employee', 'staff', 'personnel'];
            const departmentKeywords = ['department', 'division', 'team'];
            const salaryKeywords = ['salary', 'wage', 'payroll'];

            // --- Template 1: Financial/Sales Analysis ---
            const revenueCol = findCol(revenueKeywords);
            const dateCol = findCol(dateKeywords);
            const categoryCol = findCol(categoryKeywords);
            if (revenueCol) {
                const config = {
                    headers: [dateCol, categoryCol, revenueCol, findCol(costKeywords), findCol(quantityKeywords)].filter(Boolean),
                    userKPIs: [{ id: `kpi-tpl-1`, title: `ยอดขายรวม`, calculation: 'sum', column: revenueCol }],
                    userCharts: []
                };
                if (dateCol) config.userCharts.push({ id: 'chart-tpl-1', title: 'ยอดขายตามเวลา', type: 'line', groupBy: dateCol, metric: revenueCol, aggregation: 'sum' });
                if (categoryCol) config.userCharts.push({ id: 'chart-tpl-2', title: `ยอดขายตามหมวดหมู่`, type: 'bar', groupBy: categoryCol, metric: revenueCol, aggregation: 'sum' });
                templates.push({ name: "วิเคราะห์ยอดขาย (Sales Analysis)", description: "ภาพรวมยอดขาย, แนวโน้มตามเวลา และแบ่งตามหมวดหมู่", config });
            }

            // --- Template 2: Product Performance ---
            const productCol = findCol(productKeywords);
            const quantityCol = findCol(quantityKeywords);
            if (productCol && (quantityCol || revenueCol)) {
                const metricCol = revenueCol || quantityCol;
                const config = {
                    headers: [productCol, categoryCol, quantityCol, revenueCol].filter(Boolean),
                    userKPIs: [
                        { id: `kpi-tpl-3`, title: `จำนวนสินค้า (SKU)`, calculation: 'uniqueCount', column: productCol },
                        { id: `kpi-tpl-4`, title: `จำนวนชิ้นทั้งหมด`, calculation: 'sum', column: quantityCol }
                    ].filter(kpi => kpi.column),
                    userCharts: [{ id: 'chart-tpl-3', title: `Top 10 สินค้าขายดี`, type: 'bar', groupBy: productCol, metric: metricCol, aggregation: 'sum' }]
                };
                templates.push({ name: "วิเคราะห์ประสิทธิภาพสินค้า (Product Performance)", description: "ดูภาพรวมสินค้า, จำนวนที่ขาย และจัดอันดับสินค้าขายดี", config });
            }

            // --- Template 3: Geographic Analysis ---
            const geoCol = findCol(geoKeywords);
            if (geoCol && revenueCol) {
                const config = {
                    headers: [geoCol, revenueCol].filter(Boolean),
                    userKPIs: [{ id: `kpi-tpl-5`, title: `จำนวนพื้นที่`, calculation: 'uniqueCount', column: geoCol }],
                    userCharts: [{ id: 'chart-tpl-4', title: `ยอดขายตามพื้นที่`, type: 'pie', groupBy: geoCol, metric: revenueCol, aggregation: 'sum' }]
                };
                templates.push({ name: "วิเคราะห์เชิงภูมิศาสตร์ (Geographic Analysis)", description: "สรุปยอดขายหรือข้อมูลตามพื้นที่ทางภูมิศาสตร์", config });
            }

            // --- Template 4: HR / Employee Analysis ---
            const employeeCol = findCol(employeeKeywords);
            const departmentCol = findCol(departmentKeywords);
            const salaryCol = findCol(salaryKeywords);
            if (departmentCol && (employeeCol || salaryCol)) {
                 const metricCol = salaryCol || employeeCol;
                 const aggregation = salaryCol ? 'sum' : 'uniqueCount';
                 const kpiTitle = salaryCol ? 'ค่าจ้างรวม' : 'จำนวนพนักงาน';
                 const chartTitle = salaryCol ? 'ค่าจ้างรวมตามแผนก' : 'จำนวนพนักงานตามแผนก';
                 
                 const config = {
                    headers: [employeeCol, departmentCol, salaryCol].filter(Boolean),
                    userKPIs: [
                        { id: `kpi-tpl-6`, title: `จำนวนแผนก`, calculation: 'uniqueCount', column: departmentCol },
                        { id: `kpi-tpl-7`, title: kpiTitle, calculation: aggregation, column: metricCol }
                    ],
                    userCharts: [{ id: 'chart-tpl-5', title: chartTitle, type: 'bar', groupBy: departmentCol, metric: metricCol, aggregation: aggregation }]
                };
                templates.push({ name: "วิเคราะห์ข้อมูลบุคคล (HR Analysis)", description: "ภาพรวมพนักงานและค่าใช้จ่ายบุคลากรในแต่ละแผนก", config });
            }

            // --- Template 5: General Exploration (Fallback) ---
            if (templates.length === 0 && numericHeaders.length > 0 && allHeaders.length > numericHeaders.length) {
                const firstCategoryCol = allHeaders.find(h => !numericHeaders.includes(h));
                const firstNumericCol = numericHeaders[0];
                const config = {
                     headers: [firstCategoryCol, firstNumericCol, ...allHeaders.slice(0, 5)],
                     userKPIs: [
                        { id: 'kpi-tpl-8', title: 'จำนวนรายการทั้งหมด', calculation: 'count', column: null },
                        { id: 'kpi-tpl-9', title: `ผลรวม ${firstNumericCol}`, calculation: 'sum', column: firstNumericCol },
                     ],
                     userCharts: [{ id: 'chart-tpl-6', title: `ผลรวม ${firstNumericCol} ตาม ${firstCategoryCol}`, type: 'bar', groupBy: firstCategoryCol, metric: firstNumericCol, aggregation: 'sum' }]
                };
                templates.push({ name: "สำรวจข้อมูลเบื้องต้น (General Exploration)", description: `นับจำนวนรายการและดูผลรวมของ ${firstNumericCol} ตาม ${firstCategoryCol}`, config });
            }

            return templates;
        }

        function generateAndShowTemplates() {
            const templates = generateDashboardTemplates(allHeaders, numericHeaders);
            const container = getEl('template-card-container');
            container.innerHTML = '';

            if (templates.length === 0) {
                showHeadeerSelectionModal();
                return;
            }

            templates.forEach((template, index) => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'col-md-6';
                
                const card = document.createElement('div');
                card.className = 'card h-100 template-card border';
                card.onclick = () => applyTemplateAndInitialize(template.config);
                
                const firstChartConfig = template.config.userCharts?.[0];
                const previewCanvasId = firstChartConfig ? `preview-${firstChartConfig.id}` : `preview-empty-${index}`;

                card.innerHTML = `
                    <div class="chart-preview-container bg-light p-2 rounded-top">
                        <canvas id="${previewCanvasId}"></canvas>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title text-primary">${template.name}</h5>
                        <p class="card-text text-muted small">${template.description}</p>
                    </div>
                `;
                cardWrapper.appendChild(card);
                container.appendChild(cardWrapper);
            });
            
            templates.forEach((template, index) => {
                const firstChartConfig = template.config.userCharts?.[0];
                if (firstChartConfig) {
                    const previewCanvasId = `preview-${firstChartConfig.id}`;
                    renderPreviewChart(firstChartConfig, previewCanvasId);
                }
            });

            loadingSpinner.style.display = 'none';
            templateSelectModal.show();
        }

        function renderPreviewChart(config, canvasId) {
            const data = fullOriginalData;
            let chartData;

            if (!config.groupBy || !data || data.length === 0) return;
            
            const aggregation = config.aggregation || 'sum';
            const metric = config.metric;

            if (aggregation === 'count' || aggregation === 'uniqueCount') {
                 const counts = data.reduce((acc, row) => {
                    const key = row[config.groupBy] || 'N/A';
                    if (!acc[key]) acc[key] = new Set();
                    if (aggregation === 'uniqueCount') acc[key].add(row[metric]);
                    else acc[key].add(row[config.groupBy]); // Just count occurrences
                    return acc;
                }, {});
                chartData = { labels: Object.keys(counts), values: Object.values(counts).map(s => s.size) };
            } else { // sum, average
                if (!metric || !numericHeaders.includes(metric)) return;
                const metrics = data.reduce((acc, row) => {
                    const key = row[config.groupBy] || 'N/A';
                    if (!acc[key]) acc[key] = { sum: 0, count: 0 };
                    acc[key].sum += row[metric] || 0;
                    acc[key].count += 1;
                    return acc;
                }, {});
                chartData = {
                    labels: Object.keys(metrics),
                    values: Object.values(metrics).map(m => aggregation === 'sum' ? m.sum : (m.sum / m.count))
                };
            }

            const maxPreviewPoints = 10;
            if (chartData.labels.length > maxPreviewPoints) {
                const combined = chartData.labels.map((label, i) => ({ label, value: chartData.values[i] }));
                combined.sort((a, b) => b.value - a.value);
                chartData.labels = combined.slice(0, maxPreviewPoints).map(d => d.label);
                chartData.values = combined.slice(0, maxPreviewPoints).map(d => d.value);
            }

            const ctx = getEl(canvasId)?.getContext('2d');
            if (!ctx) return;

            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            chartInstances[canvasId] = new Chart(ctx, {
                type: config.type,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        data: chartData.values,
                        backgroundColor: config.type === 'line' ? 'rgba(0, 123, 255, 0.1)' : ['#0d6efd', '#6c757d', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#fd7e14'],
                        borderColor: '#0d6efd',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: config.type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false }, datalabels: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function applyTemplateAndInitialize(config) {
            templateSelectModal.hide();
            loadingSpinner.style.display = 'block';

            headers = [...new Set(config.headers)];
            userKPIs = config.userKPIs || [];
            userCharts = config.userCharts || [];
            activeFilters = config.activeFilters || [];

            originalData = fullOriginalData.map(fullRow => {
                const newRow = {};
                headers.forEach(h => { newRow[h] = fullRow[h]; });
                return newRow;
            });
            
            loadingSpinner.style.display = 'none';
            initializeDashboard();
        }

        function renderSheetSwitcher() {
            const container = getEl('sheet-switcher-container');
            container.innerHTML = '';
            const sheetNames = Object.keys(workbookDataStore);

            if (sheetNames.length <= 1) {
                container.innerHTML = `<p class="text-muted small mt-1">ชีตที่แสดงผล: ${currentSheetName}</p>`;
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex align-items-center gap-2';
            wrapper.innerHTML = `<label for="sheet-switcher" class="form-label mb-0 small text-muted">เลือกชีตที่แสดงผล:</label>`;
            
            const select = document.createElement('select');
            select.id = 'sheet-switcher';
            select.className = 'form-select form-select-sm w-auto';

            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentSheetName) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                setActiveSheet(e.target.value);
            });

            wrapper.appendChild(select);
            container.appendChild(wrapper);
        }

        function initializeDashboard() {
            fileInfoEl.textContent = `ไฟล์: ${currentFileName}`;
            uploadView.classList.add('d-none');
            dashboardView.classList.remove('d-none');
            
            renderSheetSwitcher();

            sortKey = headers.length > 0 ? headers[0] : '';
            renderTableHeader();

            const savedConfig = loadStateFromLocalStorage();
            const headersMatch = savedConfig && savedConfig.headers && savedConfig.headers.every(h => headers.includes(h)) && savedConfig.headers.length === headers.length;

            if (headersMatch) {
                applyConfiguration(savedConfig);
            } else {
                applyFiltersAndRender();
            }
        }

        // --- TABLE RENDERING ---
        function renderTableHeader() {
            tableHeaderEl.innerHTML = '';
            const tr = document.createElement('tr');
            tr.className = 'main-header-row';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'p-3 sortable-header';
                th.dataset.sortKey = header;
                th.textContent = header;
                tr.appendChild(th);
            });
            tableHeaderEl.appendChild(tr);
            updateSortIndicators();
        }
        
        function renderTableTotalRow() {
            const existingTotalRow = tableHeaderEl.querySelector('.total-row');
            if (existingTotalRow) existingTotalRow.remove();
            if (filteredData.length === 0) return;

            const totalRow = document.createElement('tr');
            totalRow.className = 'table-light total-row fw-bold';

            let hasPlacedTotalLabel = false;
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'p-3';
                if (numericHeaders.includes(header)) {
                    const total = filteredData.reduce((sum, row) => sum + (row[header] || 0), 0);
                    th.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    th.classList.add('text-end');
                } else {
                    if (!hasPlacedTotalLabel) {
                        th.textContent = 'Total';
                        hasPlacedTotalLabel = true;
                    } else {
                        th.textContent = '';
                    }
                }
                totalRow.appendChild(th);
            });
            tableHeaderEl.prepend(totalRow);
        }


        function renderTableBody() {
            tableBodyEl.innerHTML = '';
            noResultsEl.classList.toggle('d-none', filteredData.length > 0);
            if (filteredData.length === 0) return;

            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            currentPage = Math.min(currentPage, totalPages) || 1;
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredData.slice(start, end);

            paginatedItems.forEach((row) => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'p-3';
                    const value = row[header];
                    
                    if (typeof value === 'number' && numericHeaders.includes(header)) {
                        td.textContent = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        td.classList.add('text-end');
                    } else {
                        td.textContent = String(value === undefined || value === null ? '' : value);
                    }
                    tr.appendChild(td);
                });
                tableBodyEl.appendChild(tr);
            });
            renderPaginationControls(filteredData.length, totalPages);
        }

        function renderPaginationControls(totalItems, totalPages) {
            paginationControls.innerHTML = '';
            if (totalItems === 0) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex align-items-center gap-3';
            const startItem = (currentPage - 1) * rowsPerPage + 1;
            const endItem = Math.min(startItem + rowsPerPage - 1, totalItems);
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-muted text-nowrap';
            pageInfo.textContent = `แสดง ${startItem} - ${endItem} จาก ${totalItems}`;

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'btn-group';
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.className = 'btn btn-outline-secondary btn-sm';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => { if (currentPage > 1) { currentPage--; renderTableBody(); } };
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.className = 'btn btn-outline-secondary btn-sm';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => { if (currentPage < totalPages) { currentPage++; renderTableBody(); } };

            buttonsContainer.append(prevButton, nextButton);
            wrapper.append(pageInfo, buttonsContainer);
            paginationControls.append(wrapper);
        }

        // --- FILTERING & SORTING ---
        function applyFiltersAndRender() {
            let data = [...originalData];
            activeFilters.forEach(filter => {
                if (filter.column && filter.value) {
                    const filterValue = String(filter.value).toLowerCase();
                    data = data.filter(row => String(row[filter.column] || '').toLowerCase().includes(filterValue));
                }
            });

            filteredData = data;
            currentPage = 1;
            sortData();
            renderTableBody();
            renderTableTotalRow();
            renderAllKpis();
            renderAllCharts();
        }

        function addFilterRow(filterConfig = null) {
            const filterId = filterConfig ? filterConfig.id : `filter-${Date.now()}`;
            const filterRow = document.createElement('div');
            filterRow.id = filterId;
            filterRow.className = 'row g-2 align-items-center mb-2 p-2 filter-row';
            const headerOptions = headers.map(h => `<option value="${h}" ${filterConfig && filterConfig.column === h ? 'selected' : ''}>${h}</option>`).join('');
            filterRow.innerHTML = `
                <div class="col-md-5"><select class="form-select form-select-sm" data-role="column"><option value="">-- เลือกคอลัมน์ --</option>${headerOptions}</select></div>
                <div class="col-md-6"><input type="text" class="form-control form-control-sm" placeholder="ค่าที่ต้องการค้นหา..." data-role="value" value="${filterConfig ? (filterConfig.value || '') : ''}"></div>
                <div class="col-md-1"><button class="btn btn-sm btn-outline-danger" data-role="remove"><i class="bi bi-trash"></i></button></div>`;
            filterBuilderContainer.appendChild(filterRow);
            
            const currentFilter = activeFilters.find(f => f.id === filterId);
            const newFilter = currentFilter || { id: filterId, column: filterConfig?.column || '', value: filterConfig?.value || '' };
            if (!currentFilter) activeFilters.push(newFilter);

            filterRow.querySelector('[data-role="column"]').addEventListener('change', (e) => { newFilter.column = e.target.value; saveStateToLocalStorage(); applyFiltersAndRender(); });
            filterRow.querySelector('[data-role="value"]').addEventListener('input', (e) => { newFilter.value = e.target.value; saveStateToLocalStorage(); applyFiltersAndRender(); });
            filterRow.querySelector('[data-role="remove"]').addEventListener('click', () => { activeFilters = activeFilters.filter(f => f.id !== filterId); filterRow.remove(); saveStateToLocalStorage(); applyFiltersAndRender(); });
        }

        function sortData() {
            if (!sortKey) return;
            const isNumeric = numericHeaders.includes(sortKey);
            
            filteredData.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                if (isNumeric) { valA = valA || 0; valB = valB || 0; } 
                else { valA = String(valA || '').toLowerCase(); valB = String(valB || '').toLowerCase(); }
                if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
            updateSortIndicators();
        }

        function updateSortIndicators() {
            tableHeaderEl.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sortKey === sortKey) th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            });
        }

        // --- KPI ---
        function openCreateKpiModal() {
            getEl('create-kpi-form').reset();
            const calcSelect = getEl('kpi-calculation');
            const colSelect = getEl('kpi-column');
            const colContainer = getEl('kpi-column-container');
            
            calcSelect.innerHTML = `<option value="">-- เลือก --</option><option value="sum">ผลรวม (Sum)</option><option value="average">ค่าเฉลี่ย (Average)</option><option value="uniqueCount">จำนวนนับ (ไม่ซ้ำ)</option><option value="count">จำนวนนับ (ทั้งหมด)</option>`;
            
            calcSelect.onchange = () => {
                const selection = calcSelect.value;
                let colOptions = '';
                if (selection === 'sum' || selection === 'average') { colOptions = numericHeaders.map(h => `<option value="${h}">${h}</option>`).join(''); colContainer.style.display = 'block'; } 
                else if (selection === 'uniqueCount') { colOptions = headers.map(h => `<option value="${h}">${h}</option>`).join(''); colContainer.style.display = 'block'; } 
                else { colContainer.style.display = 'none'; }
                colSelect.innerHTML = colOptions;
            };
            calcSelect.onchange();
            kpiModal.show();
        }

        function saveKpi() {
            const form = getEl('create-kpi-form');
            if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
            const calculation = getEl('kpi-calculation').value;
            userKPIs.push({
                id: `kpi-${Date.now()}`,
                title: getEl('kpi-title').value,
                calculation: calculation,
                column: calculation !== 'count' ? getEl('kpi-column').value : null
            });
            kpiModal.hide();
            saveStateToLocalStorage();
            renderAllKpis();
        }

        function renderAllKpis() {
            kpisContainer.innerHTML = '';
            if (userKPIs.length === 0) { kpisContainer.appendChild(noKpisPlaceholder); noKpisPlaceholder.style.display = 'block'; return; }
            noKpisPlaceholder.style.display = 'none';

            userKPIs.forEach(config => {
                let value = 0;
                const data = filteredData;
                switch(config.calculation) {
                    case 'sum': value = data.reduce((sum, row) => sum + (row[config.column] || 0), 0); break;
                    case 'average': const sum = data.reduce((s, row) => s + (row[config.column] || 0), 0); value = data.length > 0 ? sum / data.length : 0; break;
                    case 'uniqueCount': value = new Set(data.map(row => row[config.column])).size; break;
                    case 'count': value = data.length; break;
                }
                const kpiWrapper = document.createElement('div');
                kpiWrapper.className = 'col-md-4 col-sm-6 mb-4 kpi-card';
                let formattedValue = (config.calculation === 'sum' || config.calculation === 'average') ? value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : value.toLocaleString();
                kpiWrapper.innerHTML = `<div class="card position-relative"><div class="card-body text-center p-4"><h2 class="text-muted fs-6 mb-2">${config.title}</h2><p class="h2 fw-bold text-primary mb-0">${formattedValue}</p></div><button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" style="line-height:1" data-kpi-id="${config.id}" title="ลบ KPI">&times;</button></div>`;
                kpisContainer.appendChild(kpiWrapper);
            });
            kpisContainer.querySelectorAll('[data-kpi-id]').forEach(btn => btn.addEventListener('click', (e) => { userKPIs = userKPIs.filter(k => k.id !== e.currentTarget.dataset.kpiId); saveStateToLocalStorage(); renderAllKpis(); }));
        }

        // --- CHARTS ---
        function openCreateChartModal() {
            getEl('create-chart-form').reset();
            const groupBySelect = getEl('chart-group-by');
            const metricSelect = getEl('chart-metric');
            const aggregationContainer = getEl('metric-aggregation-container');
            const allHeaderOptions = headers.map(h => `<option value="${h}">${h}</option>`).join('');
            const numericHeaderOptions = numericHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
            groupBySelect.innerHTML = `<option value="">-- เลือกคอลัมน์ --</option>${allHeaderOptions}`;
            metricSelect.innerHTML = `<option value="count">นับจำนวนแถว (Count)</option>${numericHeaderOptions}`;
            metricSelect.onchange = function() { aggregationContainer.style.display = this.value === 'count' ? 'none' : 'block'; };
            metricSelect.onchange();
            createChartModal.show();
        }

        function saveChart() {
            const form = getEl('create-chart-form');
            if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
            userCharts.push({
                id: `chart-${Date.now()}`, title: getEl('chart-title').value, type: getEl('chart-type').value,
                groupBy: getEl('chart-group-by').value, metric: getEl('chart-metric').value, aggregation: getEl('chart-metric-aggregation').value
            });
            createChartModal.hide();
            saveStateToLocalStorage();
            renderAllCharts();
        }

        function renderAllCharts() {
            chartsContainer.innerHTML = '';
            if (userCharts.length === 0) { chartsContainer.appendChild(noChartsPlaceholder); noChartsPlaceholder.style.display = 'block'; return; }
            noChartsPlaceholder.style.display = 'none';

            userCharts.forEach(config => {
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'col-lg-6 mb-4';
                chartWrapper.innerHTML = `<div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>${config.title}</span><button class="btn btn-sm btn-outline-light rounded-circle" data-chart-id="${config.id}" title="ลบกราฟ"><i class="bi bi-x-lg"></i></button></div><div class="card-body"><div class="chart-container" style="height: 400px;"><canvas id="${config.id}"></canvas></div></div></div>`;
                chartsContainer.appendChild(chartWrapper);
                renderChart(config);
            });
            chartsContainer.querySelectorAll('[data-chart-id]').forEach(btn => btn.addEventListener('click', (e) => {
                const chartId = e.currentTarget.dataset.chartId;
                userCharts = userCharts.filter(c => c.id !== chartId);
                if (chartInstances[chartId]) { chartInstances[chartId].destroy(); delete chartInstances[chartId]; }
                saveStateToLocalStorage();
                renderAllCharts();
            }));
        }

        function renderChart(config) {
            const data = filteredData;
            let chartData;
            if (config.metric === 'count') {
                const counts = data.reduce((acc, row) => { const key = row[config.groupBy] || 'N/A'; acc[key] = (acc[key] || 0) + 1; return acc; }, {});
                chartData = { labels: Object.keys(counts), values: Object.values(counts) };
            } else {
                const metrics = data.reduce((acc, row) => {
                    const key = row[config.groupBy] || 'N/A';
                    if (!acc[key]) { acc[key] = { sum: 0, count: 0 }; }
                    acc[key].sum += row[config.metric] || 0;
                    acc[key].count += 1;
                    return acc;
                }, {});
                chartData = { labels: Object.keys(metrics), values: Object.values(metrics).map(m => config.aggregation === 'sum' ? m.sum : (m.sum / m.count)) };
            }

            const ctx = getEl(config.id).getContext('2d');
            if (chartInstances[config.id]) chartInstances[config.id].destroy();
            const isBarOrLine = ['bar', 'line'].includes(config.type);
            
            chartInstances[config.id] = new Chart(ctx, {
                type: config.type,
                data: {
                    labels: chartData.labels,
                    datasets: [{ label: config.title, data: chartData.values, backgroundColor: isBarOrLine ? 'rgba(0, 123, 255, 0.7)' : ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14'], borderColor: 'rgba(0, 123, 255, 1)', fill: config.type === 'line' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: !isBarOrLine },
                        tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } let val = context.parsed.y ?? context.parsed; label += val.toLocaleString(undefined, { maximumFractionDigits: 2 }); return label; } } },
                        datalabels: { display: false }
                    },
                    scales: { x: { display: isBarOrLine }, y: { display: isBarOrLine } }
                }
            });
        }
        
        // --- SAVE/LOAD CONFIGURATION ---
        function getConfigurationObject() { return { headers, userKPIs, userCharts, activeFilters }; }
        function applyConfiguration(config) {
            userKPIs = config.userKPIs || [];
            userCharts = config.userCharts || [];
            activeFilters = config.activeFilters || [];
            filterBuilderContainer.innerHTML = '';
            activeFilters.forEach(filter => addFilterRow(filter));
            applyFiltersAndRender();
        }
        function getLocalStorageKey() { return `analyzerConfig_${currentFileName}_${currentSheetName}`; }
        function saveStateToLocalStorage() { try { localStorage.setItem(getLocalStorageKey(), JSON.stringify(getConfigurationObject())); } catch (e) { console.error("Error saving state", e); } }
        function loadStateFromLocalStorage() { try { const state = localStorage.getItem(getLocalStorageKey()); return state ? JSON.parse(state) : null; } catch (e) { console.error("Error loading state", e); return null; } }
        function clearLocalStorage() { if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบการตั้งค่าที่บันทึกไว้ในเครื่องนี้?')) { localStorage.removeItem(getLocalStorageKey()); alert('ลบการตั้งค่าแล้ว'); window.location.reload(); } }
        function saveConfigToFile() {
            const blob = new Blob([JSON.stringify(getConfigurationObject(), null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `analyzer_config_${currentFileName}_${currentSheetName}.json`;
            a.click(); URL.revokeObjectURL(a.href);
        }
        function loadConfigFromFile(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config && Array.isArray(config.headers) && Array.isArray(config.userKPIs)) {
                        headers = config.headers.filter(h => allHeaders.includes(h));
                        if (headers.length === 0) { alert('ไฟล์การตั้งค่าไม่มีคอลัมน์ที่ตรงกับข้อมูลปัจจุบัน'); return; }
                        originalData = fullOriginalData.map(fullRow => { const newRow = {}; headers.forEach(h => { newRow[h] = fullRow[h]; }); return newRow; });
                        detectNumericHeaders(); convertNumericColumns(originalData, numericHeaders);
                        renderTableHeader(); applyConfiguration(config); saveStateToLocalStorage();
                        alert('นำเข้าการตั้งค่าสำเร็จ');
                    } else { alert('ไฟล์การตั้งค่าไม่ถูกต้อง'); }
                } catch (err) { alert('เกิดข้อผิดพลาดในการอ่านไฟล์'); console.error(err); }
            };
            reader.readAsText(file); event.target.value = '';
        }

        // --- EXPORT ---
        function exportTableToCSV() {
            if (filteredData.length === 0) { alert("ไม่มีข้อมูลให้ส่งออก"); return; }
            const escapeCSV = (value) => { const str = String(value ?? ''); if (str.includes(',') || str.includes('"') || str.includes('\n')) return `"${str.replace(/"/g, '""')}"`; return str; };
            const csvRows = [headers.join(','), ...filteredData.map(row => headers.map(header => escapeCSV(row[header])).join(','))];
            const blob = new Blob([`\uFEFF${csvRows.join('\n')}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `data_export_${currentFileName}_${currentSheetName}.csv`;
            link.click(); URL.revokeObjectURL(link.href);
        }
        async function exportDashboardToPDF() {
            const { jsPDF } = window.jspdf;
            const exportArea = getEl('pdf-export-area'), actions = getEl('dashboard-actions'), pdfButton = getEl('export-pdf-btn');
            const originalButtonText = pdfButton.innerHTML;
            pdfButton.disabled = true; pdfButton.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>กำลังสร้าง...`; actions.style.visibility = 'hidden';
            try {
                const canvas = await html2canvas(exportArea, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                pdf.setFont('Sarabun-Regular');
                const pdfWidth = pdf.internal.pageSize.getWidth(), pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20, imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`dashboard_export_${currentFileName}_${currentSheetName}.pdf`);
            } catch (err) { console.error("PDF Export Error: ", err); alert("เกิดข้อผิดพลาดในการสร้าง PDF"); } 
            finally { actions.style.visibility = 'visible'; pdfButton.disabled = false; pdfButton.innerHTML = originalButtonText; }
        }

        // --- INITIALIZATION ---
        function init() {
            Chart.register(ChartDataLabels);
            Chart.defaults.font.family = "'Sarabun', sans-serif";

            sheetSelectModal = new bootstrap.Modal(getEl('sheet-select-modal'));
            headerSelectModal = new bootstrap.Modal(getEl('header-select-modal'));
            kpiModal = new bootstrap.Modal(getEl('kpi-modal'));
            createChartModal = new bootstrap.Modal(getEl('create-chart-modal'));
            templateSelectModal = new bootstrap.Modal(getEl('template-select-modal'));

            getEl('footer-text').innerHTML = `Chatrium © ${new Date().getFullYear()}`;

            excelInput.addEventListener('change', handleFileSelection);
            getEl('upload-new-button').addEventListener('click', () => { window.location.reload(); });
            getEl('add-filter-btn').addEventListener('click', () => addFilterRow());
            getEl('create-kpi-btn').addEventListener('click', openCreateKpiModal);
            getEl('save-kpi-button').addEventListener('click', saveKpi);
            getEl('create-chart-btn').addEventListener('click', openCreateChartModal);
            getEl('save-chart-button').addEventListener('click', saveChart);
            getEl('apply-header-select-button').addEventListener('click', applyHeaderSelection);
            getEl('rows-per-page-select').addEventListener('change', (e) => { rowsPerPage = parseInt(e.target.value, 10); currentPage = 1; renderTableBody(); });

            getEl('process-selected-sheets-btn').addEventListener('click', () => {
                const selectedSheets = Array.from(getEl('sheet-list').querySelectorAll('input:checked')).map(cb => cb.value);
                if (selectedSheets.length === 0) {
                    alert('กรุณาเลือกอย่างน้อยหนึ่งชีต');
                    return;
                }
                processAndStoreSheets(selectedSheets);
            });

            getEl('start-from-scratch-button').addEventListener('click', () => {
                templateSelectModal.hide();
                showHeadeerSelectionModal();
            });

            getEl('save-config-btn').addEventListener('click', saveConfigToFile);
            getEl('load-config-btn').addEventListener('click', () => getEl('load-config-input').click());
            getEl('load-config-input').addEventListener('change', loadConfigFromFile);
            getEl('clear-storage-btn').addEventListener('click', clearLocalStorage);
            getEl('export-csv-btn').addEventListener('click', exportTableToCSV);
            getEl('export-pdf-btn').addEventListener('click', exportDashboardToPDF);

            tableHeaderEl.addEventListener('click', (e) => {
                const header = e.target.closest('th');
                if (!header || !header.dataset.sortKey) return;
                const newSortKey = header.dataset.sortKey;
                sortDir = sortKey === newSortKey ? (sortDir === 'asc' ? 'desc' : 'asc') : 'asc';
                sortKey = newSortKey;
                sortData();
                renderTableBody();
            });
        }
        
        init();
    </script>
</body>
</html>
