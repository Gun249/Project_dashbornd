<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Hub - อัปโหลดและวิเคราะห์ข้อมูล</title>

    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f4f7f6;
            font-family: 'Sarabun', sans-serif;
        }
        .upload-container {
            max-width: 800px;
            margin: 4rem auto;
            padding: 3rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
        }
        .dashboard-container { display: none; }
        .card {
            border: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
            border-radius: 20px;
            height: 100%;
        }
        .card-header {
            background: linear-gradient(to right, #4a69bd, #6a89cc);
            color: white;
            font-weight: bold;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom: none;
            padding: 1rem 1.5rem;
        }
        .kpi-card { position: relative; overflow: hidden; }
        .kpi-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.15; color: #000; }
        .kpi-value { font-size: 2.2rem; font-weight: bold; }
        .kpi-label { font-size: 1.1rem; color: #6c757d; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .staffing-chart-container { position: relative; height: 450px; width: 100%; }
        .sc-table-container { max-height: 400px; overflow-y: auto; }
        .sc-table th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;}
        .sc-table td { color: white; font-weight: bold; text-align: center; vertical-align: middle; }
        .sc-table tr td:first-child { color: #212529; background-color: #f8f9fa; font-weight: bold; position: sticky; left: 0; z-index: 2;}
        #header-map-form .row {
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .dynamic-chart-card {
            background-color: #f8f9fa;
        }
        .comparison-kpi-card {
            border-left: 5px solid;
        }
    </style>
</head>
<body>

    <div class="container-fluid p-4">
        
        <!-- Upload Section -->
        <div id="upload-section" class="upload-container">
            <h1 class="mb-3">Analysis Hub</h1>
            <p class="text-muted">กรุณาอัปโหลดไฟล์ Excel และเลือกประเภทการวิเคราะห์ (รองรับการเลือกหลายไฟล์เพื่อเปรียบเทียบ)</p>
            <hr class="my-4">
            
            <div class="mb-3">
                <label for="excel-file-input" class="form-label fw-bold">1. เลือกไฟล์ Excel</label>
                <input type="file" id="excel-file-input" class="form-control form-control-lg" accept=".xlsx, .xls" multiple>
            </div>

            <div class="mb-4">
                <label for="analysis-type-select" class="form-label fw-bold">2. เลือกประเภทการวิเคราะห์</label>
                <select id="analysis-type-select" class="form-select form-select-lg">
                    <option value="" disabled selected>-- กรุณาเลือก --</option>
                    <option value="guest">วิเคราะห์ข้อมูลลูกค้าโรงแรม (รองรับโหมดเปรียบเทียบ)</option>
                    <option value="hr">วิเคราะห์ข้อมูลพนักงาน (HR) (ยังไม่รองรับโหมดเปรียบเทียบ)</option>
                </select>
            </div>
            
            <button id="verify-file-button" class="btn btn-primary btn-lg w-100">ตรวจสอบไฟล์</button>

            <div id="loading-spinner" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">กำลังประมวลผลไฟล์...</p>
            </div>
            <div id="upload-error" class="text-danger mt-3"></div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 id="dashboard-title" class="mb-0">แดชบอร์ดวิเคราะห์ข้อมูล</h1>
                <button id="reset-button" class="btn btn-secondary"><i class="bi bi-arrow-clockwise me-2"></i>เลือกไฟล์และการวิเคราะห์ใหม่</button>
            </div>
            <div id="dashboard-content"></div>
        </div>
    </div>

    <!-- Header Mapping Modal -->
    <div class="modal fade" id="headerMappingModal" tabindex="-1" aria-labelledby="headerMappingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="headerMappingModalLabel">ตั้งค่าการจับคู่ Header</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info" id="modal-info-text"></div>
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label for="sheet-select" class="form-label">เลือกชีตที่ต้องการวิเคราะห์:</label>
                    <select id="sheet-select" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label for="header-row-input" class="form-label">แถวของ Header (เริ่มต้นที่ 1):</label>
                    <input type="number" id="header-row-input" class="form-control" value="1" min="1">
                </div>
            </div>
            <p class="text-muted">กรุณาจับคู่คอลัมน์ในไฟล์ Excel ของคุณกับข้อมูลที่โปรแกรมต้องการเพื่อการวิเคราะห์ที่ถูกต้อง</p>
            <hr>
            <div id="header-map-form">
              <!-- Mapping form will be generated here by JavaScript -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-success" id="save-template-button"><i class="bi bi-save me-2"></i>บันทึกการตั้งค่า</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
            <button type="button" class="btn btn-primary" id="run-analysis-button">เริ่มการวิเคราะห์</button>
          </div>
        </div>
      </div>
    </div>


    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    $(function() {
        // --- INITIAL SETUP ---
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.plugins.datalabels.color = '#333';
        Chart.defaults.plugins.datalabels.font.weight = 'bold';

        // --- GLOBAL STATE ---
        let chartInstances = {};
        let workbook;
        let headerMappingModal = new bootstrap.Modal(document.getElementById('headerMappingModal'));
        let allFilesData = [];
        let processedGuestFiles = [];
        
        // --- HR ANALYSIS STATE ---
        let allParsedData_HR = [];
        let allTurnoverData_HR = [];
        let allServiceChargeData_HR = [];
        
        // --- GUEST ANALYSIS STATE ---
        const GUEST_REQUIRED_FIELDS = {
            name: { label: 'ชื่อ (First Name)', aliases: ['firstname', 'name', 'guestname'] },
            lastName: { label: 'นามสกุล (Last Name)', aliases: ['lastname'] },
            email: { label: 'อีเมล (Email)', aliases: ['email'] },
            country: { label: 'สัญชาติ (Country)', aliases: ['countrydesc', 'country'] },
            roomType: { label: 'ประเภทห้อง (Room Type)', aliases: ['rmtype', 'roomtype', 'rmtype'] },
            source: { label: 'ช่องทางการจอง (Source)', aliases: ['source'] },
            market: { label: 'Market', aliases: ['market'] },
            roomNumber: { label: 'หมายเลขห้อง (RM#)', aliases: ['rm', 'rm#'] },
            bookedDate: { label: 'วันที่จอง (Booked)', aliases: ['booked'] },
            checkIn: { label: 'Check-in', aliases: ['arrival', 'checkin', 'arrivaldate'] },
            checkOut: { label: 'Check-out', aliases: ['depart', 'departure', 'checkout', 'departuredate'] },
            roomRevenue: { label: 'รายได้ห้องพัก (Room Rev)', aliases: ['rmrev', 'roomrevenue', 'roomrev'] },
            fandbRevenue: { label: 'รายได้ F&B (F&B Rev)', aliases: ['fbrev', 'fandbrevenue', 'fbrev', 'f&brev'] },
            extraRevenue: { label: 'รายได้เสริม (Extra Rev)', aliases: ['extrarev', 'extrarevenue'] }
        };


        // --- CONSTANTS ---
        const HOTEL_CODES_HR = ['CHRB', 'CRRB', 'CRST', 'ES', 'CGB', 'MHSC', 'MHRB', 'MMSB', 'SDAO', 'LKYT', 'CHRY', 'CNSJ', 'CHH'];
        const EMPLOYMENT_TYPES_HR = ['FT', 'CT', 'OS'];
        const STAFFING_DEPARTMENTS_HR = ['FO', 'HKP', 'Laundry', 'Fitness', 'F&B Service', 'Kitchen', 'A&G', 'Finance', 'Procurement', 'IT', 'HR', 'Security', 'Sales', 'Engineering', 'MarComm', 'E-Commerce', 'Commercial', 'Service Quality Assurance', 'Golf Operations', 'Golf Maintenance', 'Test'];
        const STAFFING_DEPARTMENT_SET_HR = new Set(STAFFING_DEPARTMENTS_HR.map(dept => dept.toUpperCase()));
        const CHART_COLORS = ['#5B9BD5', '#ED7D31', '#A5A5A5', '#FFC000', '#4472C4', '#70AD47', '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69', '#fd7e14', '#6610f2', '#e83e8c'];

        // --- EVENT HANDLERS ---
        $('#verify-file-button').on('click', handleFileVerification);
        $('#run-analysis-button').on('click', runAnalysisFromMapping);
        $('#reset-button').on('click', resetToUpload);
        $('#save-template-button').on('click', saveMappingTemplate);

        $('#sheet-select, #header-row-input').on('change', function() {
            if(allFilesData.length > 0) {
                const sheetName = $('#sheet-select').val();
                const headerRow = parseInt($('#header-row-input').val(), 10) - 1;
                if(sheetName && headerRow >= 0) {
                     const firstFileWorkbook = allFilesData[0].workbook;
                     const worksheet = firstFileWorkbook.Sheets[sheetName];
                     const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '', raw: false });
                     if(data[headerRow]) {
                        populateMappingModal(data[headerRow]);
                     }
                }
            }
        });
        
        async function handleFileVerification() {
            const files = $('#excel-file-input')[0].files;
            const analysisType = $('#analysis-type-select').val();

            $('#upload-error').text('');
            if (files.length === 0 || !analysisType) {
                $('#upload-error').text('กรุณาเลือกไฟล์และประเภทการวิเคราะห์');
                return;
            }

            $('#loading-spinner').show();
            
            try {
                if (analysisType === 'hr' && files.length > 1) {
                    throw new Error("โหมดวิเคราะห์ HR รองรับการอัปโหลดทีละ 1 ไฟล์เท่านั้น");
                }
                
                allFilesData = [];
                const fileReadPromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            resolve({ fileName: file.name, workbook: wb });
                        };
                        reader.onerror = err => reject(err);
                        reader.readAsArrayBuffer(file);
                    });
                });
                
                allFilesData = await Promise.all(fileReadPromises);
                workbook = allFilesData[0].workbook;

                const sheetNames = workbook.SheetNames;
                $('#sheet-select').html(sheetNames.map(name => `<option value="${name}">${name}</option>`).join(''));

                if (analysisType === 'guest') {
                    if (files.length > 1) {
                        $('#modal-info-text').text(`โหมดเปรียบเทียบ: พบ ${files.length} ไฟล์ การตั้งค่า Header นี้จะถูกใช้กับทุกไฟล์`).show();
                    } else {
                        $('#modal-info-text').hide();
                    }
                    $('#sheet-select').trigger('change');
                    headerMappingModal.show();
                } else if (analysisType === 'hr') {
                    runHrAnalysis(); 
                    $('#upload-section').hide();
                    $('#dashboard-container').show();
                }

            } catch(error) {
                console.error("Error during verification:", error);
                $('#upload-error').html(`<p class="text-danger">${error.message}</p>`);
            } finally {
                $('#loading-spinner').hide();
            }
        }

        function populateMappingModal(fileHeaders) {
            const formContainer = $('#header-map-form');
            formContainer.empty();
            const optionHtml = fileHeaders.map(h => `<option value="${h}">${h}</option>`).join('');
            const savedTemplate = JSON.parse(localStorage.getItem('guestAnalysisTemplate') || '{}');

            for (const key in GUEST_REQUIRED_FIELDS) {
                const field = GUEST_REQUIRED_FIELDS[key];
                const formRow = `
                    <div class="row">
                        <div class="col-sm-5"><label for="map-${key}" class="col-form-label">${field.label}:</label></div>
                        <div class="col-sm-7">
                            <select class="form-select" id="map-${key}" data-field-key="${key}">
                                <option value="">-- ไม่ใช้คอลัมน์นี้ --</option>
                                ${optionHtml}
                            </select>
                        </div>
                    </div>`;
                formContainer.append(formRow);

                let bestMatch = '';
                if(savedTemplate[key] && fileHeaders.includes(savedTemplate[key])) { 
                    bestMatch = savedTemplate[key];
                } else {
                    let bestMatchScore = 0;
                    fileHeaders.forEach(header => {
                        const normalizedHeader = String(header || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                        let currentScore = 0;
                        if (GUEST_REQUIRED_FIELDS[key].aliases.some(alias => normalizedHeader.includes(alias.replace(/[^a-z0-9]/g, '')))) {
                            currentScore = 50;
                        }
                        if (currentScore > bestMatchScore) {
                            bestMatchScore = currentScore;
                            bestMatch = header;
                        }
                    });
                }
                if (bestMatch) { $(`#map-${key}`).val(bestMatch); }
            }
        }
        
        function saveMappingTemplate() {
            const userMapping = {};
            $('#header-map-form select').each(function() {
                const fieldKey = $(this).data('field-key');
                const selectedHeader = $(this).val();
                if (fieldKey && selectedHeader) {
                    userMapping[fieldKey] = selectedHeader;
                }
            });
            localStorage.setItem('guestAnalysisTemplate', JSON.stringify(userMapping));
            alert('บันทึกการตั้งค่า Header เรียบร้อยแล้ว!');
        }

        function runAnalysisFromMapping() {
             const analysisType = $('#analysis-type-select').val();
             if (analysisType === 'guest') {
                const userMapping = {};
                 $('#header-map-form select').each(function() {
                    const fieldKey = $(this).data('field-key');
                    const selectedHeader = $(this).val();
                    if (fieldKey && selectedHeader) { userMapping[fieldKey] = selectedHeader; }
                });
                
                const headerRow = parseInt($('#header-row-input').val(), 10) - 1;
                const sheetName = $('#sheet-select').val();
                
                processedGuestFiles = allFilesData.map(fileInfo => {
                    const worksheet = fileInfo.workbook.Sheets[sheetName];
                    if (!worksheet) {
                        console.warn(`Sheet "${sheetName}" not found in file "${fileInfo.fileName}". Skipping.`);
                        return null;
                    }
                    const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '', raw: false });
                    const mappedData = mapData_Guest(dataArray, userMapping, headerRow);
                    return { fileName: fileInfo.fileName, data: mappedData };
                }).filter(Boolean);
                
                renderDashboardLayout_Guest(processedGuestFiles);

                headerMappingModal.hide();
                $('#upload-section').hide();
                $('#dashboard-container').show();
             }
        }

        // =================================================================
        // --- HR ANALYSIS FUNCTIONS ---
        // =================================================================
        function runHrAnalysis() {
            allParsedData_HR = [];
            allTurnoverData_HR = [];
            allServiceChargeData_HR = [];
            
            const staffingSheetName = workbook.SheetNames[0];
            if (staffingSheetName) {
                const worksheet = workbook.Sheets[staffingSheetName];
                const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: false });
                allParsedData_HR = parseMultiLevelHeaderData_HR(dataAsArray);
            }

            const turnoverSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === 'turnover');
            if (turnoverSheetName) {
                const worksheet = workbook.Sheets[turnoverSheetName];
                const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: false });
                allTurnoverData_HR = parseGenericMonthlyData_HR(dataAsArray, 'turnover');
            }
            
            const serviceChargeSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim().replace(/ /g,'') === 'servicecharge');
            if (serviceChargeSheetName) {
                 const worksheet = workbook.Sheets[serviceChargeSheetName];
                 const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: false });
                 allServiceChargeData_HR = parseGenericMonthlyData_HR(dataAsArray, 'service_charge');
            }

            if (allParsedData_HR.length === 0 && allTurnoverData_HR.length === 0 && allServiceChargeData_HR.length === 0) {
                throw new Error("ไม่พบข้อมูล HR ที่สามารถนำมาวิเคราะห์ได้ในไฟล์");
            }
            
            renderHrDashboard();
        }

        function renderHrDashboard() {
            destroyAllCharts();
            $('#dashboard-title').text('แดชบอร์ดวิเคราะห์ข้อมูลพนักงาน (HR)');
            const content = `
                <div class="row mb-4">
                    <div class="col-12"><div class="card"><div class="card-body">
                        <label for="period-filter-hr" class="form-label fw-bold">1. เลือกมุมมองข้อมูลหลัก</label>
                        <select id="period-filter-hr" class="form-select form-select-lg border-primary"></select>
                    </div></div></div>
                </div>
                <div class="row mb-4">
                    <div class="col-12"><div class="card"><div class="card-body">
                        <p class="form-label fw-bold">2. ฟิลเตอร์รอง</p>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4"><label for="hotel-filter-hr" class="form-label">โรงแรม</label><select id="hotel-filter-hr" class="form-select"></select></div>
                            <div class="col-md-4"><label for="type-filter-hr" class="form-label">ประเภทพนักงาน</label><select id="type-filter-hr" class="form-select"></select></div>
                            <div class="col-md-4"><button id="clear-secondary-filters-hr" class="btn btn-outline-secondary w-100"><i class="bi bi-x-circle me-2"></i>ล้างฟิลเตอร์</button></div>
                        </div>
                    </div></div></div>
                </div>
                <div id="main-content-area-hr"></div>`;

            $('#dashboard-content').html(content);
            populateFilters_HR();
            
            $('#dashboard-content').off('change.hr').on('change.hr', '#period-filter-hr, #hotel-filter-hr, #type-filter-hr, #department-filter-hr', updateDashboardView_HR);
            $('#dashboard-content').off('click.hr').on('click.hr', '#clear-secondary-filters-hr', () => {
                $('#hotel-filter-hr, #type-filter-hr').prop('selectedIndex', 0);
                 if ($('#department-filter-hr').length) {
                    $('#department-filter-hr').prop('selectedIndex', 0);
                }
                updateDashboardView_HR();
            });
            
            updateDashboardView_HR();
        }

        function populateFilters_HR() {
            const allHotels = [...new Set([...allParsedData_HR.map(d => d.hotel), ...allTurnoverData_HR.map(d => d.hotel), ...allServiceChargeData_HR.map(d => d.hotel)])].sort();
            const types = ['All', ...[...new Set(allParsedData_HR.map(d => d.type))].sort()];
            const staffingPeriods = [...new Set(allParsedData_HR.map(d => d.period))].sort((a, b) => parsePeriodToDate(a) - parsePeriodToDate(b));
            
            $('#hotel-filter-hr').html(['All', ...allHotels].map(h => `<option>${h}</option>`).join(''));
            $('#type-filter-hr').html(types.map(t => `<option>${t}</option>`).join(''));
            
            let periodOptions = `<option value="" disabled selected>--- กรุณาเลือกมุมมอง ---</option>`;
            if (allServiceChargeData_HR.length > 0) periodOptions += `<option value="ALL_SERVICE_CHARGE">ภาพรวม Service Charge</option>`;
            if (allTurnoverData_HR.length > 0) periodOptions += `<option value="ALL_TURNOVER">ภาพรวม Turnover</option>`;
            periodOptions += staffingPeriods.map(p => `<option value="${p}">ข้อมูลประจำเดือน ${p}</option>`).join('');
            $('#period-filter-hr').html(periodOptions);
        }

        function populateDepartmentFilter_HR(currentValue) {
            const departments = ['All', ...[...new Set(allParsedData_HR.map(d => d.department))].sort()];
            const optionsHtml = departments.map(d => `<option value="${d}" ${d === currentValue ? 'selected' : ''}>${d}</option>`).join('');
            $('#department-filter-hr').html(optionsHtml);
        }

        function updateDashboardView_HR() {
            const currentDept = $('#department-filter-hr').val();
            $('#main-content-area-hr').empty();
            const selectedPeriod = $('#period-filter-hr').val();

            if (!selectedPeriod) {
                 $('#main-content-area-hr').append(`<div class="d-flex align-items-center justify-content-center text-muted" style="min-height:300px;"><h4><i class="bi bi-arrow-up-circle-fill me-2"></i>กรุณาเลือกมุมมองจากเมนูด้านบน</h4></div>`);
                 return;
            }

            if (selectedPeriod === 'ALL_TURNOVER') {
                if (allTurnoverData_HR.length > 0) {
                    $('#main-content-area-hr').append(`<div id="turnover-section-hr" class="row mt-4"></div>`);
                    updateTurnoverSection_HR();
                }
            } else if (selectedPeriod === 'ALL_SERVICE_CHARGE') {
                 if (allServiceChargeData_HR.length > 0) {
                    $('#main-content-area-hr').append(`<div id="sc-section-hr" class="row mt-4"></div>`);
                    updateServiceChargeSection_HR();
                }
            } else {
                if (allParsedData_HR.length > 0) {
                    $('#main-content-area-hr').append(`<div id="staffing-section-hr"></div>`);
                    updateStaffingCharts_HR(currentDept);
                }
                if (allTurnoverData_HR.length > 0) {
                    $('#main-content-area-hr').append(`<div id="turnover-section-hr" class="row mt-4"></div>`);
                    updateTurnoverSection_HR();
                }
            }
        }
        
        function updateStaffingCharts_HR(currentDeptValue) {
            const staffingHtml = `
                <div class="row">
                    <div class="col-lg-8 mb-4"><div class="card"><div class="card-header" id="department-chart-title-hr"></div><div class="card-body"><div class="staffing-chart-container"><canvas id="department-chart-hr"></canvas></div></div></div></div>
                    <div class="col-lg-4 mb-4"><div class="card"><div class="card-header">ตารางสรุป</div><div class="card-body"><div class="table-responsive" style="max-height: 400px;"><table class="table table-striped"><thead><tr><th>แผนก</th><th>จำนวน</th></tr></thead><tbody id="summary-table-body-hr"></tbody><tfoot class="fw-bold"><tr><td>รวม</td><td id="summary-table-total-hr"></td></tr></tfoot></table></div></div></div></div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-5">
                        <label for="department-filter-hr" class="form-label fw-bold">กรองตามแผนก (สำหรับกราฟด้านล่าง)</label>
                        <select id="department-filter-hr" class="form-select"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-4"><div class="card"><div class="card-header" id="monthly-chart-title-hr"></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="monthly-chart-hr"></canvas></div></div></div></div>
                </div>`;
            $('#staffing-section-hr').html(staffingHtml);
            
            const selectedHotel = $('#hotel-filter-hr').val();
            const selectedType = $('#type-filter-hr').val();
            const selectedPeriod = $('#period-filter-hr').val();
            
            populateDepartmentFilter_HR(currentDeptValue);
            const selectedDepartment = $('#department-filter-hr').val();

            const departmentFilteredData = allParsedData_HR.filter(d => (selectedHotel === 'All' || d.hotel === selectedHotel) && (selectedType === 'All' || d.type === selectedType) && d.period === selectedPeriod);
            const departmentTotals = departmentFilteredData.reduce((acc, item) => { acc[item.department] = (acc[item.department] || 0) + item.value; return acc; }, {});
            const sortedDepartments = Object.entries(departmentTotals).sort(([, a], [, b]) => b - a);
            createBarChart('department-chart-hr', sortedDepartments.map(d => d[0]), sortedDepartments.map(d => d[1]), 'จำนวน', 'rgba(74, 105, 189, 0.7)', 'y');
            updateSummaryTable_HR(sortedDepartments);

            const monthlyFilteredData = allParsedData_HR.filter(d => (selectedHotel === 'All' || d.hotel === selectedHotel) && (selectedType === 'All' || d.type === selectedType) && (selectedDepartment === 'All' || !selectedDepartment || d.department === selectedDepartment));
            const monthlyTotals = monthlyFilteredData.reduce((acc, item) => { acc[item.period] = (acc[item.period] || 0) + item.value; return acc; }, {});
            const sortedMonths = Object.entries(monthlyTotals).sort((a, b) => parsePeriodToDate(a[0]) - parsePeriodToDate(b[0]));
            createBarChart('monthly-chart-hr', sortedMonths.map(d => d[0]), sortedMonths.map(d => d[1]), 'จำนวน', '#20c997', 'x');

            updateTitles_HR(selectedHotel, selectedType, selectedPeriod, selectedDepartment);
        }

        function updateTurnoverSection_HR() {
            const selectedHotel = $('#hotel-filter-hr').val();
            const selectedPeriod = $('#period-filter-hr').val();

            if (selectedPeriod && selectedPeriod !== 'ALL_TURNOVER' && selectedPeriod !== 'ALL_SERVICE_CHARGE') {
                const turnoverHtml = `
                    <div class="col-lg-8 mb-4"><div class="card h-100"><div class="card-header" id="turnover-chart-title-hr"></div><div class="card-body"><div class="chart-container"><canvas id="turnover-chart-hr"></canvas></div></div></div></div>
                    <div class="col-lg-4 mb-4"><div class="card h-100"><div class="card-header">ตารางสรุป Turnover</div><div class="card-body sc-table-container"><table class="table table-striped"><thead><tr><th>โรงแรม</th><th>Turnover Rate</th></tr></thead><tbody id="turnover-summary-table-body-hr"></tbody></table></div></div></div>`;
                $('#turnover-section-hr').html(turnoverHtml);

                const periodData = allTurnoverData_HR.filter(d => d.period === selectedPeriod);
                let filteredData = (selectedHotel === 'All') ? periodData : periodData.filter(d => d.hotel === selectedHotel);
                filteredData.sort((a, b) => b.turnover - a.turnover);

                updateSimpleBarChartWithPercent('turnover-chart-hr', filteredData.map(d => d.hotel), filteredData.map(d => d.turnover), 'rgba(231, 74, 59, 0.7)');
                $('#turnover-chart-title-hr').text(`Turnover Rate ประจำเดือน ${selectedPeriod}`);

                const tableBody = $('#turnover-summary-table-body-hr').empty();
                if (filteredData.length === 0) { tableBody.html('<tr><td colspan="2" class="text-center text-muted">ไม่พบข้อมูล</td></tr>'); } 
                else { filteredData.forEach(d => { tableBody.append(`<tr><td>${d.hotel}</td><td>${d.turnover.toFixed(1)}%</td></tr>`); }); }
            } else { // ALL_TURNOVER view
                const turnoverHtml = `
                    <div class="col-12 mb-4"><div class="card"><div class="card-header" id="turnover-table-title-hr"></div><div class="card-body sc-table-container"><table class="table table-bordered table-sm"><thead id="turnover-table-head-hr"></thead><tbody id="turnover-table-body-hr"></tbody></table></div></div></div>
                    <div class="col-12 mb-4"><div class="card"><div class="card-header" id="turnover-chart-title-hr"></div><div class="card-body"><div class="chart-container" style="height: 500px;"><canvas id="turnover-chart-hr"></canvas></div></div></div></div>`;
                $('#turnover-section-hr').html(turnoverHtml);

                let filteredData = (selectedHotel === 'All') ? allTurnoverData_HR : allTurnoverData_HR.filter(d => d.hotel === selectedHotel);
                const allPeriods = [...new Set(filteredData.map(d => d.period))].sort((a, b) => parsePeriodToDate(a) - parsePeriodToDate(b));
                const hotelsInSelection = [...new Set(filteredData.map(d => d.hotel))].sort();

                let tableHead = `<tr><th>เดือน</th>${hotelsInSelection.map(h => `<th>${h}</th>`).join('')}</tr>`;
                $('#turnover-table-head-hr').html(tableHead);

                let tableBody = '';
                allPeriods.forEach(p => {
                    tableBody += `<tr><td class="text-nowrap fw-bold" style="background-color: #f8f9fa;">${p}</td>`;
                    hotelsInSelection.forEach(h => {
                        const entry = filteredData.find(d => d.period === p && d.hotel === h);
                        tableBody += `<td class="text-center">${entry ? entry.turnover.toFixed(1) + '%' : '-'}</td>`;
                    });
                    tableBody += `</tr>`;
                });
                $('#turnover-table-body-hr').html(tableBody);
                $('#turnover-table-title-hr').text(`ตาราง Turnover Rate (${selectedHotel === 'All' ? 'ทุกโรงแรม' : selectedHotel})`);

                const datasets = hotelsInSelection.map((hotel, index) => ({
                    label: hotel,
                    data: allPeriods.map(p => filteredData.find(d => d.period === p && d.hotel === hotel)?.turnover || null),
                    backgroundColor: CHART_COLORS[index % CHART_COLORS.length],
                }));
                updateGroupedBarChart('turnover-chart-hr', allPeriods, datasets);
                $('#turnover-chart-title-hr').text(`Turnover Rate รายเดือน (${selectedHotel === 'All' ? 'ทุกโรงแรม' : selectedHotel})`);
            }
        }

        function updateServiceChargeSection_HR() {
            const scHtml = `
                <div class="col-12 mb-4"><div class="card"><div class="card-header" id="sc-table-title-hr">Service Charge รายเดือน</div><div class="card-body sc-table-container"><table class="table table-bordered table-sm sc-table"><thead id="sc-table-head-hr"></thead><tbody id="sc-table-body-hr"></tbody></table></div></div></div>
                <div class="col-12 mb-4"><div class="card"><div class="card-header">Average Service Charge</div><div class="card-body"><div class="chart-container" style="height: 450px;"><canvas id="avg-sc-chart-hr"></canvas></div></div></div></div>`;
            $('#sc-section-hr').html(scHtml);
            
            const selectedHotel = $('#hotel-filter-hr').val();
            const hotels = [...new Set(allServiceChargeData_HR.map(d => d.hotel))].sort();
            const periods = [...new Set(allServiceChargeData_HR.map(d => d.period))].sort((a,b) => parsePeriodToDate(a) - parsePeriodToDate(b));
            
            let tableHead = `<tr><th>เดือน</th>${hotels.filter(h => selectedHotel === 'All' || selectedHotel === h).map(h => `<th>${h}</th>`).join('')}</tr>`;
            $('#sc-table-head-hr').html(tableHead);
            
            const allValues = allServiceChargeData_HR.map(d => d.service_charge);
            const min = Math.min(...allValues), max = Math.max(...allValues);

            let tableBody = '';
            periods.forEach(p => {
                tableBody += `<tr><td>${p}</td>`;
                hotels.forEach(h => {
                    if(selectedHotel === 'All' || selectedHotel === h) {
                        const entry = allServiceChargeData_HR.find(d => d.period === p && d.hotel === h);
                        const value = entry ? entry.service_charge : null;
                        const color = value !== null ? getColorForValue(value, min, max) : '#ffffff';
                        const textColor = value !== null ? '#ffffff' : '#212529';
                        tableBody += `<td style="background-color:${color}; color:${textColor}">${value ? value.toLocaleString() : '-'}</td>`;
                    }
                });
                tableBody += `</tr>`;
            });
            $('#sc-table-body-hr').html(tableBody);
            $('#sc-table-title-hr').text(`Service Charge รายเดือน (${selectedHotel === 'All' ? 'ทุกโรงแรม' : selectedHotel})`);

            const avgData = Array.from(allServiceChargeData_HR.reduce((map, d) => {
                const hotelData = map.get(d.hotel) || { sum: 0, count: 0 };
                hotelData.sum += d.service_charge;
                hotelData.count++;
                return map.set(d.hotel, hotelData);
            }, new Map()), ([hotel, {sum, count}]) => ({ hotel, service_charge: sum / count }));
            
            const sortedAvgData = avgData.sort((a,b) => b.service_charge - a.service_charge);
            createBarChart('avg-sc-chart-hr', sortedAvgData.map(d => d.hotel), sortedAvgData.map(d => d.service_charge), 'Average Service Charge', '#6f42c1', 'y');
        }

        function getColorForValue(value, min, max) {
            const ratio = max === min ? 1 : (value - min) / (max - min);
            const hue = ratio * 120; // Green (120) for max, Red (0) for min
            return `hsl(${hue}, 90%, 45%)`;
        }

        function updateSummaryTable_HR(sortedDepartments) {
            const tableBody = $('#summary-table-body-hr').empty();
            if (sortedDepartments.length === 0) {
                tableBody.html('<tr><td colspan="2" class="text-center text-muted">ไม่พบข้อมูล</td></tr>');
                $('#summary-table-total-hr').text('0'); return;
            }
            let total = 0;
            sortedDepartments.forEach(([dept, value]) => {
                tableBody.append(`<tr><td>${dept}</td><td>${value.toLocaleString()}</td></tr>`);
                total += value;
            });
            $('#summary-table-total-hr').text(total.toLocaleString());
        }

        function updateTitles_HR(hotel, type, period, department) {
            const format = (val, defaultVal = 'ทั้งหมด') => (val === 'All' || !val) ? defaultVal : val;
            const hotelText = format(hotel, 'ทุกโรงแรม');
            
            $('#department-chart-title-hr').text(`สรุปพนักงานตามแผนก (${hotelText}, ${format(type)}, ${format(period)})`);
            $('#monthly-chart-title-hr').text(`ยอดรวมพนักงานแต่ละเดือน (${hotelText}, แผนก: ${format(department)})`);
        }

        function updateSimpleBarChartWithPercent(chartId, labels, data, color) {
            if (chartInstances[chartId]) chartInstances[chartId].destroy();
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            chartInstances[chartId] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Turnover', data, backgroundColor: color }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(1) + '%' }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed.y.toFixed(2)}%` } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => v + '%' } } } }
            });
        }

        function updateGroupedBarChart(chartId, labels, datasets) {
            if (chartInstances[chartId]) chartInstances[chartId].destroy();
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            chartInstances[chartId] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', display: datasets.length > 1 }, datalabels: { display: true, anchor: 'end', align: 'top', rotation: -45, font: {size: 9}, formatter: v => v > 0 ? v.toFixed(1) + '%' : '', color: '#444' }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toFixed(2)}%` } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => v + '%' } } } }
            });
        }

        function parseMultiLevelHeaderData_HR(sheetData) {
            const structuredData = [];
            const searchLimit = Math.min(25, sheetData.length);
            const upperHotelCodes = HOTEL_CODES_HR.map(c => c.toUpperCase());
            const upperEmpTypes = EMPLOYMENT_TYPES_HR.map(c => c.toUpperCase());

            let hotelRowScores = [], typeRowScores = [], periodRowScores = [];
            for(let i = 0; i < searchLimit; i++) {
                const row = sheetData[i] || [];
                let hotelScore = 0, typeScore = 0, periodScore = 0;
                for (const cell of row) {
                    const cellStr = String(cell || '').trim().toUpperCase();
                    if (upperHotelCodes.includes(cellStr)) hotelScore++;
                    if (upperEmpTypes.includes(cellStr)) typeScore++;
                    if (cell instanceof Date || /^[A-Za-z]{3}-\d{2}$/.test(cellStr)) periodScore++;
                }
                hotelRowScores.push({ index: i, score: hotelScore });
                typeRowScores.push({ index: i, score: typeScore });
                periodRowScores.push({ index: i, score: periodScore });
            }

            const findBestRow = (scores) => scores.reduce((best, current) => (current.score > best.score) ? current : best, {index: -1, score: 0});

            let hotelRowIndex = findBestRow(hotelRowScores).index;
            let typeRowIndex = findBestRow(typeRowScores).index;
            let periodRowIndex = findBestRow(periodRowScores).index;
            
            if(hotelRowIndex === -1 || typeRowIndex === -1 || periodRowIndex === -1 || findBestRow(periodRowScores).score < 2) {
                throw new Error("Staffing: ไม่สามารถหาแถว Header (โรงแรม, ประเภท, หรือเดือน) ที่ถูกต้องและครบถ้วนได้ กรุณาตรวจสอบรูปแบบไฟล์");
            }
            
            const columnContextMap = new Map();
            const hotelRow = sheetData[hotelRowIndex], typeRow = sheetData[typeRowIndex], periodRow = sheetData[periodRowIndex];
            const maxCols = Math.max((hotelRow || []).length, (typeRow || []).length, (periodRow || []).length);
            
            const findLastValidValue = (row, colIndex, validSet) => {
                for (let k = colIndex; k >= 0; k--) {
                    const cellValue = String((row || [])[k] || '').trim().toUpperCase();
                    const foundValue = validSet.find(v => v.toUpperCase() === cellValue);
                    if (foundValue) return foundValue;
                } return null; };

            for (let j = 1; j < maxCols; j++) {
                const currentHotel = findLastValidValue(hotelRow, j, HOTEL_CODES_HR);
                const currentType = findLastValidValue(typeRow, j, EMPLOYMENT_TYPES_HR);
                let periodCell = periodRow[j];
                let formattedPeriod = (periodCell instanceof Date) ? `${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][periodCell.getMonth()]}-${String(periodCell.getFullYear()).slice(-2)}` : String(periodCell || '').trim();
                if (/^[A-Za-z]{3}-\d{2}$/.test(formattedPeriod) && currentHotel && currentType) {
                    columnContextMap.set(j, { hotel: currentHotel, type: currentType, period: formattedPeriod });
                }
            }
            
            for (let i = periodRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i] || [];
                const rawDeptName = String(row[0] || '').trim();
                if (!rawDeptName || !STAFFING_DEPARTMENT_SET_HR.has(rawDeptName.toUpperCase())) continue;
                columnContextMap.forEach((context, colIndex) => {
                    const numericValue = parseFloat(row[colIndex]);
                    if (!isNaN(numericValue) && isFinite(numericValue)) {
                        structuredData.push({ ...context, department: rawDeptName, value: numericValue });
                    }
                });
            }
            return structuredData;
        }

        function parseGenericMonthlyData_HR(sheetData, valueKey) {
            const parsedData = [];
            let headerRowIndex = -1, periodColIndex = -1;
            const upperHotelCodes = HOTEL_CODES_HR.map(h => h.toUpperCase());
            const searchLimit = Math.min(15, sheetData.length);

            let bestHeaderMatch = { index: -1, count: 0 };
            for (let i = 0; i < searchLimit; i++) {
                const row = sheetData[i] || [];
                const headerCount = row.filter(cell => upperHotelCodes.includes(String(cell || '').trim().toUpperCase())).length;
                if (headerCount > 1 && headerCount > bestHeaderMatch.count) { bestHeaderMatch = { index: i, count: headerCount }; }
            }
            headerRowIndex = bestHeaderMatch.index;
            if (headerRowIndex === -1) return [];

            let bestPeriodMatch = { index: -1, count: 0 };
            for (let j = 0; j < Math.min(10, (sheetData[headerRowIndex] || []).length); j++) {
                let periodCount = 0;
                for (let i = headerRowIndex + 1; i < searchLimit; i++) {
                    const cellValue = String((sheetData[i] || [])[j] || '').trim();
                    if (/^[A-Za-z]{3}-\d{2}$/.test(cellValue) || /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)$/i.test(cellValue)) periodCount++;
                }
                if (periodCount > bestPeriodMatch.count) bestPeriodMatch = { index: j, count: periodCount };
            }
            periodColIndex = bestPeriodMatch.index > -1 ? bestPeriodMatch.index : 0;

            const headerRow = sheetData[headerRowIndex] || [];
            for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
                const row = sheetData[i] || [];
                const periodCell = row[periodColIndex];
                if (!periodCell || String(periodCell).trim().toUpperCase().includes('TOTAL')) continue;
                
                let periodRaw = String(periodCell || '').trim();
                let finalPeriod = '';
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                if (/^[A-Za-z]{3}$/.test(periodRaw) && monthNames.some(m => m.toLowerCase() === periodRaw.toLowerCase())) {
                    const currentYear = new Date().getFullYear().toString().slice(-2);
                    finalPeriod = `${periodRaw.charAt(0).toUpperCase() + periodRaw.slice(1).toLowerCase()}-${currentYear}`;
                } else if (periodCell instanceof Date) {
                    finalPeriod = `${monthNames[periodCell.getMonth()]}-${String(periodCell.getFullYear()).slice(-2)}`;
                } else { finalPeriod = periodRaw; }
                if (!/^[A-Za-z]{3}-\d{2}$/.test(finalPeriod)) continue; 

                for (let j = 0; j < headerRow.length; j++) {
                    if (j === periodColIndex) continue;
                    const headerUpper = String(headerRow[j] || '').trim().toUpperCase();
                    if (!upperHotelCodes.includes(headerUpper)) continue;
                    
                    const rawValue = row[j];
                    let finalValue;
                    if (typeof rawValue === 'number') { finalValue = (valueKey === 'turnover' && rawValue < 1 && rawValue > 0) ? rawValue * 100 : rawValue; } 
                    else if (typeof rawValue === 'string' && rawValue.trim() !== '') { finalValue = parseFloat(rawValue.replace(/[%,]/g, '')); } 
                    else { finalValue = parseFloat(rawValue); }

                    if (!isNaN(finalValue) && isFinite(finalValue)) {
                        parsedData.push({ hotel: headerUpper, period: finalPeriod, [valueKey]: finalValue });
                    }
                }
            }
            return parsedData;
        }


        // ========================================================================
        // --- GUEST ANALYSIS FUNCTIONS (Single & Comparison) ---
        // ========================================================================
        
        function runGuestAnalysis(userMapping) {
            const headerRow = parseInt($('#header-row-input').val(), 10) - 1;
            const sheetName = $('#sheet-select').val();
            const worksheet = workbook.Sheets[sheetName];
            const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '', raw: false });
            const customerData = mapData_Guest(dataArray, userMapping, headerRow);
            renderSingleGuestDashboard(customerData);
        }
        
        function runGuestComparison(userMapping) {
            renderComparisonDashboard(processedGuestFiles, userMapping);
        }
        
        function renderDashboardLayout_Guest(processedFiles) {
            destroyAllCharts();
            let fileSelectorHtml = '';
            if (processedFiles.length > 1) {
                fileSelectorHtml = `
                    <div class="col-md-4">
                        <label for="mode-selector" class="form-label">โหมดการแสดงผล:</label>
                        <select id="mode-selector" class="form-select">
                            <option value="single">วิเคราะห์ไฟล์เดี่ยว</option>
                            <option value="comparison">เปรียบเทียบทุกไฟล์</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="single-file-selector-container">
                        <label for="single-file-selector" class="form-label">เลือกไฟล์ที่จะแสดง:</label>
                        <select id="single-file-selector" class="form-select">
                            ${processedFiles.map(f => `<option value="${f.fileName}">${f.fileName.replace(/\.xlsx?$/, '')}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            const content = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    ${fileSelectorHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboard-main-area"></div>
            `;
            
            $('#dashboard-content').html(content);

            $('#mode-selector').on('change', function() {
                const selectedMode = $(this).val();
                if (selectedMode === 'single') {
                    $('#single-file-selector-container').show();
                    $('#single-file-selector').trigger('change');
                } else {
                    $('#single-file-selector-container').hide();
                    renderComparisonDashboard(processedFiles);
                }
            });

            $('#single-file-selector').on('change', function() {
                const selectedFileName = $(this).val();
                const fileData = processedFiles.find(f => f.fileName === selectedFileName);
                if (fileData) {
                    renderSingleGuestDashboard(fileData.data);
                }
            });

            // Initial render
            if (processedFiles.length > 1) {
                 $('#mode-selector').val('comparison').trigger('change');
            } else {
                 $('#single-file-selector').trigger('change');
            }
        }


        function renderComparisonDashboard(processedFiles) {
            destroyAllCharts();
            $('#dashboard-title').text(`เปรียบเทียบข้อมูลลูกค้า (${processedFiles.length} ไฟล์)`);
            $('#dashboard-main-area').empty();

            let content = '<div class="row">';
            const allMetrics = processedFiles.map(file => ({
                fileName: file.fileName.replace(/\.xlsx?$/, ''),
                metrics: calculateMetrics_Guest(file.data)
            }));
            
            // KPI Comparison
            const kpiList = [
                { key: 'totalRevenue', label: 'รายได้รวม', format: formatCurrency },
                { key: 'adr', label: 'ADR', format: formatCurrency },
                { key: 'actualBookingCount', label: 'Booking จริง', format: formatNumber },
                { key: 'avgStay', label: 'คืนพักเฉลี่ย', format: (val) => val }
            ];

            kpiList.forEach(kpi => {
                content += `<div class="col-xl-3 col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">${kpi.label}</div>
                                    <div class="card-body">`;
                allMetrics.forEach((fileMetrics, index) => {
                    const value = fileMetrics.metrics[kpi.key] || 0;
                    content += `<div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted small">${fileMetrics.fileName}</span>
                                    <span class="fw-bold" style="color:${CHART_COLORS[index % CHART_COLORS.length]}">${kpi.format(value)}</span>
                                </div>`;
                });
                content += `</div></div></div>`;
            });
            content += '</div> <div class="row">';

            // Grouped Bar Charts
            const comparisonCategories = [
                { key: 'topCountries', title: 'สัญชาติ' },
                { key: 'topRoomTypes', title: 'ประเภทห้องพัก' },
                { key: 'topSources', title: 'ช่องทางการจอง' }
            ];

            comparisonCategories.forEach(cat => {
                content += `<div class="col-lg-6 mb-4">
                                <div class="card">
                                    <div class="card-header">เปรียบเทียบ 10 อันดับแรก ${cat.title}</div>
                                    <div class="card-body"><div class="chart-container" style="height: 400px"><canvas id="compare-${cat.key}"></canvas></div></div>
                                </div>
                            </div>`;
            });
            content += '</div>';

            $('#dashboard-main-area').html(content);
            
            comparisonCategories.forEach(cat => {
                 generateTopNComparisonChart(`compare-${cat.key}`, allMetrics, cat.key);
            });
        }
        
        function generateTopNComparisonChart(canvasId, allMetrics, metricsKey) {
            const allItems = new Set();
            allMetrics.forEach(fileMetrics => {
                const topItems = fileMetrics.metrics[metricsKey] || [];
                topItems.slice(0, 5).forEach(item => allItems.add(item[0]));
            });
            const labels = Array.from(allItems);

            const datasets = allMetrics.map((fileMetrics, index) => {
                const dataMap = new Map(fileMetrics.metrics[metricsKey] || []);
                return {
                    label: fileMetrics.fileName,
                    data: labels.map(label => dataMap.get(label) || 0),
                    backgroundColor: CHART_COLORS[index % CHART_COLORS.length]
                };
            });
            
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId);
            if(ctx) {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                        scales: { x: { stacked: false }, y: { stacked: false } }
                    }
                });
            }
        }


        function renderSingleGuestDashboard(customerData) {
            destroyAllCharts();
            const metrics = calculateMetrics_Guest(customerData);
            const insights = generateInsights_Guest(metrics);

            const content = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-success text-white"><i class="bi bi-lightbulb-fill me-2"></i>ข้อมูลสรุปที่น่าสนใจ</div>
                            <div class="card-body">
                                <p>${insights}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="exportable-content-guest">
                    <h3 class="mb-3 text-secondary">ภาพรวมหลัก</h3>
                    <div class="row mb-4">
                         <div class="col-xl-3 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-journal-check kpi-icon"></i><div id="actual-booking-label-guest" class="kpi-label">Booking จริง</div><div id="actual-bookings-guest" class="kpi-value text-primary">0</div></div></div></div>
                         <div class="col-xl-3 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-cash-stack kpi-icon"></i><div class="kpi-label">รายได้รวม</div><div id="total-revenue-guest" class="kpi-value text-success">฿0</div></div></div></div>
                         <div class="col-xl-3 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-graph-up-arrow kpi-icon"></i><div class="kpi-label">ADR</div><div id="adr-guest" class="kpi-value text-info">฿0</div></div></div></div>
                         <div class="col-xl-3 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-moon-stars-fill kpi-icon"></i><div class="kpi-label">จำนวนคืนพักเฉลี่ย</div><div id="avg-stay-guest" class="kpi-value text-warning">0</div></div></div></div>
                    </div>
                     <h3 class="mb-3 text-secondary">สรุปรายได้ตามประเภท</h3>
                    <div class="row mb-4">
                        <div class="col-xl-4 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-door-open-fill kpi-icon"></i><div class="kpi-label">รายได้ห้องพัก</div><div id="room-revenue-total-guest" class="kpi-value text-secondary">฿0</div></div></div></div>
                        <div class="col-xl-4 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-cup-hot-fill kpi-icon"></i><div class="kpi-label">รายได้อาหาร/เครื่องดื่ม</div><div id="fandb-revenue-total-guest" class="kpi-value text-primary">฿0</div></div></div></div>
                        <div class="col-xl-4 col-md-6 mb-4"><div class="card kpi-card"><div class="card-body"><i class="bi bi-gem kpi-icon"></i><div class="kpi-label">รายได้เสริม</div><div id="extra-revenue-total-guest" class="kpi-value text-danger">฿0</div></div></div></div>
                    </div>
                    <div class="row mb-4"><div class="col-12"><div class="card"><div class="card-header">10 อันดับลูกค้าที่ใช้จ่ายสูงสุด</div><div class="card-body"><div class="chart-container" style="height: 400px;"><canvas id="topSpendersChart-guest"></canvas></div></div></div></div></div>
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">คุณภาพข้อมูลอีเมล</div><div class="card-body"><div class="chart-container"><canvas id="emailQualityChart-guest"></canvas></div></div></div></div>
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">สัดส่วนรายได้ตามประเภท</div><div class="card-body"><div class="chart-container"><canvas id="revenueBreakdownChart-guest"></canvas></div></div></div></div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">อันดับประเภทห้องพัก</div><div class="card-body"><div class="chart-container"><canvas id="roomTypeChart-guest"></canvas></div></div></div></div>
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">อันดับช่องทางการจอง</div><div class="card-body"><div class="chart-container"><canvas id="sourceChart-guest"></canvas></div></div></div></div>
                    </div>
                     <div class="row mb-4">
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">อันดับ Market</div><div class="card-body"><div class="chart-container"><canvas id="marketChart-guest"></canvas></div></div></div></div>
                        <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">อันดับสัญชาติลูกค้า</div><div class="card-body"><div class="chart-container"><canvas id="countryChart-guest"></canvas></div></div></div></div>
                    </div>
                </div>
                
                <!-- DYNAMIC CHART BUILDER -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card dynamic-chart-card">
                            <div class="card-header"><i class="bi bi-tools me-2"></i>สร้างกราฟของคุณ</div>
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-3">
                                        <label for="dynamic-metric" class="form-label">ข้อมูลที่ต้องการวัด (แกน Y):</label>
                                        <select id="dynamic-metric" class="form-select"></select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dynamic-dimension" class="form-label">มิติในการเปรียบเทียบ (แกน X):</label>
                                        <select id="dynamic-dimension" class="form-select"></select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dynamic-chart-type" class="form-label">รูปแบบกราฟ:</label>
                                        <select id="dynamic-chart-type" class="form-select">
                                            <option value="bar">กราฟแท่ง</option>
                                            <option value="line">กราฟเส้น</option>
                                            <option value="pie">กราฟวงกลม</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button id="generate-dynamic-chart" class="btn btn-success w-100">สร้างกราฟ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dynamic-chart-container" class="row"></div>

                <div class="row mt-4"><div class="col-12"><div class="card"><div class="card-header">ข้อมูลลูกค้าทั้งหมด</div><div class="card-body"><div class="table-responsive"><table id="customerTable-guest" class="table table-striped table-bordered" style="width:100%"><thead></thead><tbody></tbody></table></div></div></div></div></div>
                `;
            $('#dashboard-main-area').html(content);
            renderGuestStaticDashboard(customerData, metrics); 
            renderDynamicChartBuilder(customerData);
        }
        
        function renderGuestStaticDashboard(customerData, metrics) {
             $('#actual-bookings-guest').text(formatNumber(metrics.actualBookingCount));
            $('#actual-booking-label-guest').html(`Booking จริง <small>(${formatNumber(metrics.totalRows)} rows)</small>`);
            $('#total-revenue-guest').text(formatCurrency(metrics.totalRevenue));
            $('#adr-guest').text(formatCurrency(metrics.adr));
            $('#avg-stay-guest').text(metrics.avgStay);
            $('#room-revenue-total-guest').text(formatCurrency(metrics.totalRoomRevenue));
            $('#fandb-revenue-total-guest').text(formatCurrency(metrics.totalFandbRevenue));
            $('#extra-revenue-total-guest').text(formatCurrency(metrics.totalExtraRevenue));

            createBarChart('topSpendersChart-guest', metrics.topSpenders.map(s => s[0]), metrics.topSpenders.map(s => s[1]), 'ยอดใช้จ่าย', CHART_COLORS[5], 'y');
            createBarChart('emailQualityChart-guest', ['อีเมลไม่ซ้ำ', 'อีเมลซ้ำ', 'ไม่มี/ผิดรูปแบบ'], [metrics.emailQuality.unique, metrics.emailQuality.duplicate, metrics.emailQuality.invalid], 'คุณภาพอีเมล', ['#70AD47', '#FFC000', '#ED7D31']);
            createBarChart('revenueBreakdownChart-guest', metrics.revenueBreakdown.map(d => d.label), metrics.revenueBreakdown.map(d => d.value), 'ประเภทรายได้', CHART_COLORS);
            createBarChart('countryChart-guest', metrics.topCountries.map(d=>d[0]), metrics.topCountries.map(d=>d[1]), 'สัญชาติ', CHART_COLORS[1], 'y');
            createBarChart('roomTypeChart-guest', metrics.topRoomTypes.map(d=>d[0]), metrics.topRoomTypes.map(d=>d[1]), 'ประเภทห้อง', CHART_COLORS[3], 'y');
            createBarChart('sourceChart-guest', metrics.topSources.map(d=>d[0]), metrics.topSources.map(d=>d[1]), 'ช่องทางจอง', CHART_COLORS[0], 'y');
            createBarChart('marketChart-guest', metrics.topMarkets.map(d=>d[0]), metrics.topMarkets.map(d=>d[1]), 'Market', CHART_COLORS[7], 'y');

            if ($.fn.DataTable.isDataTable('#customerTable-guest')) { $('#customerTable-guest').DataTable().destroy(); }
            const tableBody = $('#customerTable-guest tbody').empty();
            $('#customerTable-guest thead').html(`<tr><th>RM#</th><th>Booked Date</th><th>ชื่อ-นามสกุล</th><th>Email</th><th>สัญชาติ</th><th>ประเภทห้อง</th><th>ช่องทางจอง</th><th>รายได้รวม</th></tr>`);
            customerData.forEach(c => {
                const fullName = ((c.name || '') + ' ' + (c.lastName || '')).trim();
                const bookedDate = c.bookedDate instanceof Date ? c.bookedDate.toLocaleDateString('th-TH') : (c.bookedDate || 'N/A');
                tableBody.append(`<tr><td>${c.roomNumber || 'N/A'}</td><td>${bookedDate}</td><td>${fullName}</td><td>${c.email || 'N/A'}</td><td>${c.country || ''}</td><td>${c.roomType || ''}</td><td>${c.source || ''}</td><td>${formatCurrency(c.totalBill)}</td></tr>`);
            });
            new DataTable('#customerTable-guest', { responsive: true, destroy: true, order: [[7, 'desc']] });
        }
        
        function renderDynamicChartBuilder(data) {
            if (!data || data.length === 0) return;

            const numericCols = Object.keys(data[0]).filter(key => typeof data[0][key] === 'number');
            const categoricalCols = Object.keys(data[0]).filter(key => typeof data[0][key] === 'string' && new Set(data.map(d => d[key])).size > 1 && new Set(data.map(d => d[key])).size < 50);

            $('#dynamic-metric').html(numericCols.map(col => `<option value="${col}">${col}</option>`).join(''));
            $('#dynamic-dimension').html(categoricalCols.map(col => `<option value="${col}">${col}</option>`).join(''));
            
            $('#generate-dynamic-chart').on('click', function() {
                const metric = $('#dynamic-metric').val();
                const dimension = $('#dynamic-dimension').val();
                const chartType = $('#dynamic-chart-type').val();
                createDynamicChart(data, metric, dimension, chartType);
            });
        }
        
        let dynamicChartCount = 0;
        function createDynamicChart(data, metric, dimension, chartType) {
            dynamicChartCount++;
            const chartId = `dynamic-chart-${dynamicChartCount}`;
            const chartContainerHtml = `
                <div class="col-md-6 mb-4" id="card-${chartId}">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                           <span>${metric} by ${dimension}</span>
                           <button class="btn-close btn-close-white" onclick="document.getElementById('card-${chartId}').remove()"></button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container"><canvas id="${chartId}"></canvas></div>
                        </div>
                    </div>
                </div>`;
            $('#dynamic-chart-container').append(chartContainerHtml);

            const groupedData = data.reduce((acc, item) => {
                const key = item[dimension] || 'ไม่ระบุ';
                acc[key] = (acc[key] || 0) + (item[metric] || 0);
                return acc;
            }, {});
            
            const sortedData = Object.entries(groupedData).sort((a,b) => b[1] - a[1]).slice(0, 15);

            const labels = sortedData.map(item => item[0]);
            const values = sortedData.map(item => item[1]);
            
            if (chartInstances[chartId]) { chartInstances[chartId].destroy(); }
            const ctx = document.getElementById(chartId);
            chartInstances[chartId] = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: metric,
                        data: values,
                        backgroundColor: CHART_COLORS,
                        borderColor: '#fff',
                        borderWidth: chartType === 'pie' ? 2 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: chartType === 'pie' },
                        datalabels: {
                            formatter: (value, context) => {
                                if (chartType === 'pie') {
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / sum * 100).toFixed(1) + '%';
                                    return percentage;
                                }
                                return formatNumber(value);
                            },
                            color: chartType === 'pie' ? '#fff' : '#333'
                        }
                    }
                }
            });
        }
        
        function generateInsights_Guest(metrics) {
            let insights = [];
            if (!metrics || Object.keys(metrics).length === 0) return "ไม่สามารถสร้างข้อมูลสรุปได้";

            if (metrics.topCountries && metrics.topCountries.length > 0) {
                insights.push(`<strong>ลูกค้าอันดับ 1:</strong> มาจากประเทศ 
                    <span class="badge bg-primary fs-6">${metrics.topCountries[0][0]}</span>
                     คิดเป็น ${metrics.topCountries[0][1]} Booking.`);
            }
             if (metrics.topSources && metrics.topSources.length > 0) {
                insights.push(`<strong>ช่องทางยอดนิยม:</strong> 
                    <span class="badge bg-info fs-6">${metrics.topSources[0][0]}</span> ถูกใช้ในการจองมากที่สุด.`);
            }

            const invalidEmailRate = (metrics.emailQuality.invalid + metrics.emailQuality.duplicate) / metrics.totalRows;
            if (invalidEmailRate > 0.3) {
                 insights.push(`<strong class="text-warning">คำเตือน:</strong> คุณภาพข้อมูลอีเมลค่อนข้างต่ำ 
                    (${Math.round(invalidEmailRate*100)}% ซ้ำหรือไม่ถูกต้อง) ซึ่งอาจส่งผลต่อการทำการตลาด.`);
            } else {
                 insights.push(`<strong class="text-success">คุณภาพข้อมูลดี:</strong> ข้อมูลอีเมลมีความถูกต้องสูง พร้อมสำหรับการทำการตลาด.`);
            }
            return insights.join('<br> • ');
        }
        
        function mapData_Guest(dataAsArray, userMapping, headerRow) {
            const mappedData = [];
            const headers = dataAsArray[headerRow].map(h => String(h || ''));
            const dataRows = dataAsArray.slice(headerRow + 1);
            
            const headerIndexMap = {};
            for (const key in userMapping) {
                headerIndexMap[key] = headers.indexOf(userMapping[key]);
            }
            
            for (const row of dataRows) {
                let newRow = {};
                for (const key in GUEST_REQUIRED_FIELDS) {
                    const index = headerIndexMap[key];
                    if (index !== -1 && index !== undefined) {
                        const value = row[index];
                        if (['roomRevenue', 'fandbRevenue', 'extraRevenue'].includes(key)) {
                             newRow[key] = parseFloat(String(value || '0').replace(/[^0-9.-]+/g,"")) || 0;
                         } else { newRow[key] = value; }
                    } else { newRow[key] = null; }
                }
                newRow.totalBill = (newRow.roomRevenue || 0) + (newRow.fandbRevenue || 0) + (newRow.extraRevenue || 0);
                mappedData.push(newRow);
            }
            return mappedData;
        }

        function calculateMetrics_Guest(customerData) {
            if (!customerData || customerData.length === 0) return {};
            const totalRows = customerData.length;
            
            // --- REVERTED TO ORIGINAL LOGIC as per user request ---
            const uniqueBookings = new Set();
            customerData.forEach(c => {
                const date = c.bookedDate instanceof Date ? c.bookedDate : new Date(c.bookedDate);
                if (c.roomNumber && c.bookedDate && !isNaN(date.getTime())) {
                    uniqueBookings.add(`${date.toISOString().split('T')[0]}_${c.roomNumber}`);
                }
            });
            const actualBookingCount = uniqueBookings.size > 0 ? uniqueBookings.size : totalRows;

            const totalNights = customerData.reduce((sum, c) => {
                const checkIn = new Date(c.checkIn);
                const checkOut = new Date(c.checkOut);
                return sum + (checkOut > checkIn ? (checkOut - checkIn) / 864e5 : 0);
            }, 0);

            const totalRevenue = customerData.reduce((sum, c) => sum + (c.totalBill || 0), 0);
            const totalRoomRevenue = customerData.reduce((sum, c) => sum + (c.roomRevenue || 0), 0);
            const totalFandbRevenue = customerData.reduce((sum, c) => sum + (c.fandbRevenue || 0), 0);
            const totalExtraRevenue = customerData.reduce((sum, c) => sum + (c.extraRevenue || 0), 0);

            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            const emailCounts = {};
            customerData.forEach(c => {
                const email = c.email ? String(c.email).trim().toLowerCase() : '';
                if (email && emailRegex.test(email)) { emailCounts[email] = (emailCounts[email] || 0) + 1; }
            });
            const duplicateEntries = Object.values(emailCounts).filter(c => c > 1).reduce((sum, c) => sum + c, 0);
            const uniqueEntries = Object.keys(emailCounts).length;
            const invalidOrMissingCount = totalRows - (duplicateEntries + uniqueEntries);
            
            const aggregatedSpenders = customerData.reduce((acc, c) => {
                const fullName = ((c.name || '') + ' ' + (c.lastName || '')).trim() || `Unknown`;
                if (fullName !== 'Unknown' && c.totalBill > 0) { acc[fullName] = (acc[fullName] || 0) + c.totalBill; }
                return acc;
            }, {});

            const getSortedCounts = (data, key) => {
                if (!key || !data || data.length === 0 || data[0][key] === undefined) return [];
                const counts = data.reduce((acc, item) => {
                    const itemKey = item[key] || 'ไม่ระบุ';
                    acc[itemKey] = (acc[itemKey] || 0) + 1;
                    return acc;
                }, {});
                return Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, 10);
            };

            return {
                totalRows,
                actualBookingCount,
                totalRevenue,
                totalRoomRevenue,
                totalFandbRevenue,
                totalExtraRevenue,
                adr: totalNights > 0 ? totalRevenue / totalNights : 0,
                avgStay: actualBookingCount > 0 ? (totalNights / actualBookingCount).toFixed(1) : 0,
                emailQuality: { unique: uniqueEntries, duplicate: duplicateEntries, invalid: invalidOrMissingCount },
                topSpenders: Object.entries(aggregatedSpenders).sort(([, a], [, b]) => b - a).slice(0, 10), 
                revenueBreakdown: [{ label: 'ห้องพัก', value: totalRoomRevenue }, { label: 'อาหาร/เครื่องดื่ม', value: totalFandbRevenue }, { label: 'อื่นๆ', value: totalExtraRevenue }],
                topRoomTypes: getSortedCounts(customerData, 'roomType'),
                topSources: getSortedCounts(customerData, 'source'),
                topMarkets: getSortedCounts(customerData, 'market'),
                topCountries: getSortedCounts(customerData, 'country'),
            };
        }

        // =================================================================
        // --- GENERAL & UTILITY FUNCTIONS ---
        // =================================================================

        function destroyAllCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
        }

        function resetToUpload() {
            destroyAllCharts();
            $('#dashboard-container').hide();
            $('#upload-section').show();
            $('#excel-file-input').val('');
            $('#analysis-type-select').prop('selectedIndex', 0);
            $('#upload-error').text('');
            workbook = null;
        }
        
        const formatCurrency = (num) => '฿' + (num || 0).toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const formatNumber = (num) => (num || 0).toLocaleString('th-TH');
        const parsePeriodToDate = (periodString) => {
            if (!periodString) return null;
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const match = String(periodString).match(/^([A-Za-z]{3})-(\d{2})$/);
            if (!match) return null;
            const month = monthNames.findIndex(m => m.toLowerCase() === match[1].toLowerCase());
            return (month !== -1) ? new Date(2000 + parseInt(match[2]), month, 1) : null;
        };

        function createBarChart(canvasId, labels, data, chartLabel, colors = CHART_COLORS, indexAxis = 'x') {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId);
            if (!ctx) { console.error(`Canvas not found: ${canvasId}`); return; }
            const options = { 
                indexAxis, responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    datalabels: { 
                        display: true, anchor: 'end', align: indexAxis === 'y' ? 'start' : 'end', 
                        color: indexAxis === 'y' ? '#ffffff' : '#333',
                        formatter: (value) => value.toLocaleString('th-TH'), font: { size: 10 }
                    } 
                }, 
                scales: { 
                    y: { beginAtZero: true }, 
                    x: { ticks: { autoSkip: false, maxRotation: indexAxis === 'x' ? 45 : 0, minRotation: indexAxis === 'x' ? 45 : 0 } } 
                }, 
                animation: { duration: 500 } 
            };
            chartInstances[canvasId] = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: chartLabel, data, backgroundColor: colors, borderRadius: 5 }] }, options });
        }
    });
    </script>
</body>
</html>
